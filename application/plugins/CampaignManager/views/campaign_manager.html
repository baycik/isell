<script>
    App.CampaignManager_index = (function ($) {
        var campaign_id = 1;
        var visibility_filter = 1;
        var campaign_list = [];
        function init() {
            Campaign.init();
        }
        Mark.pipes.month = function (index) {
            return ['', 'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'][index];
        };
        Mark.pipes.quarter = function (index) {
            return ['', 'Iкв', 'IIкв', 'IIIкв', 'IVкв'][index];
        };
        Mark.pipes.numberClear = function (number) {
            return Number(number) ? number : '';
        };


        var Campaign = {
            init: function () {
                $('#CampaignManager-tabs-holder').append('<div id="CampaignManager-tabs"></div>');
                $('#CampaignManager-tabs').tabs({
                    onSelect: function (title, index) {
                        if (campaign_list[index]) {
                            campaign_id = campaign_list[index].campaign_id;
                            Campaign.get();
                        } else {
                            Campaign.add();
                        }
                        title !== "+ Добавить кампанию" && App.store('campaign_active_tab', title);
                    }
                });
                $("#CampaignManager").click(function (e) {
                    var thisCardId = $(e.target).data('button_period_id');
                    if (thisCardId) {
                        var campaign_bonus_id = $(e.target).data('campaign_bonus_id');
                        var $next = $("#campaignBonusPeriodId_" + thisCardId).next();
                        if (!$next) {
                            return;
                        }
                        var prevCardId = $next.prop('id').split('_')[1];
                        $.post("CampaignManager/bonusPeriodDuplicate", {this_period_id: thisCardId, prev_period_id: prevCardId}, function (resp) {
                            Bonuses.periodsLoad(campaign_bonus_id);
                        });
                    }
                });
                this.load();
            },
            data: {},
            load: function () {
                $.post("CampaignManager/campaignListFetch", function (resp) {
                    campaign_list = App.json(resp);
                    for (let i in campaign_list) {
                        $('#CampaignManager-tabs').tabs('add', {title: campaign_list[i].campaign_name, index: i});
                    }
                    $('#CampaignManager-tabs').tabs('add', {title: "+ Добавить кампанию", selected: false});
                    $('#CampaignManager-tabs').tabs('select', App.store('campaign_active_tab') || 0);
                });
            },
            reload: function () {
                $('#CampaignManager-tabs').remove();
                Campaign.init();
            },
            render: function (data) {
                Campaign.data = data;
                for (let i in Campaign.data.bonuses) {
                    for (let k in Campaign.data.bonuses[i]) {
                        if (k === 'campaign_start_at' || k === 'campaign_finish_at') {
                            Campaign.data.bonuses[i][k] = Campaign.data.bonuses[i][k].substr(0, 10);
                        }
                        Campaign.data.settings[`${k}-${Campaign.data.bonuses[i].campaign_bonus_id}`] = Campaign.data.bonuses[i][k];
                    }
                }
                Mark.globals.stock_categories = data.stock_category_list;
                App.renderTpl('CampaignManager', data);
                $("#CampaignManager").css('visibility', 'visible');
                if (data.settings.subject_manager_include) {
                    data.settings.subject_manager_include = data.settings.subject_manager_include.split(',');
                }
                if (data.settings.subject_manager_exclude) {
                    data.settings.subject_manager_exclude = data.settings.subject_manager_exclude.split(',');
                }
                App.setupForm('#camp_manager_form', data.settings, 'use_inp_values').change(function (node) {
                    if (this.name.indexOf('-') > -1) {
                        var campaign_bonus_id = this.name.split('-')[1];
                        var field = this.name.split('-')[0];
                        Bonuses.update(field, App.val(this), this.title, campaign_bonus_id);
                    } else if (this.name === 'visibility_filter') {
                        visibility_filter = this.value;
                        Campaign.get();
                    } else {
                        Campaign.update(this.name, App.val(this), this.title);
                    }
                });
                $("#Campaign_delete_btn").click(function () {
                    Campaign.remove();
                });
                Clients.init();
                Bonuses.init();
            },
            get: function () {
                $.post("CampaignManager/campaignGet", {campaign_id: campaign_id, visibility_filter: visibility_filter}, function (resp) {
                    var campaign = App.json(resp);
                    Campaign.render(campaign);
                    Campaign.statistics.load();
                });
            },
            update: function (field, value, title) {
                if (field === 'subject_manager_include' || field === 'subject_manager_exclude') {
                    value = value.join(',');
                }
                $.post("CampaignManager/campaignUpdate", {campaign_id: campaign_id, field: field, value: value}, function (ok) {
                    if (ok * 1) {
                        Campaign.reload();
                        App.flash("Изменения сохранены " + title);
                    } else {
                        App.flash("Ошибка сохранения " + title);
                    }
                });
            },
            remove: function () {
                if (confirm("Удалить кампанию?")) {
                    $.post("CampaignManager/campaignRemove", {campaign_id: campaign_id}, function (ok) {
                        if (ok * 1) {
                            Campaign.reload();
                            App.flash("Кампания удалена");
                            $("#CampaignManager").css('visibility', 'hidden');
                        } else {
                            App.flash("Ошибка удаления кампании");
                        }
                    });
                }
            },
            add: function () {
                $.post("CampaignManager/campaignAdd", {campaign_name: "Новая кампания"}, function (ok) {
                    if (ok * 1) {
                        Campaign.reload();
                        App.flash("Кампания добавлена");
                    } else {
                        App.flash("Ошибка добавления кампании");
                    }
                });
            },
            statistics: {
                stat: {
                    client_count: 0,
                    invoice_count: 0,
                    total_result: 0
                },
                load: function () {
                    $.post("CampaignManager/dashboardManagerStatistics/", function (resp) {
                        var stat = App.json(resp);
                        if (!stat) {
                            $("#CampaignManagerCharts").html("<h2>Нет кампаний</h2>");
                            return;
                        }
                        Campaign.statistics.stat.client_count = stat.client_count;
                        Campaign.statistics.stat.invoice_count = stat.invoice_count;
                        Campaign.statistics.render();
                    });
                    $.post("CampaignManager/bonusCalculateCampaignTotal/", {campaign_id: campaign_id}, function (total) {
                        Campaign.statistics.stat.total_result = total;
                        Campaign.statistics.render();
                    });
                },
                render: function () {
                    var tpl=$("#CampaignManagerCharts_tpl").html();
                    $("#CampaignManagerCharts").html(Mark.up(tpl,this.stat));
                }
            }
        };

        var Clients = {
            init: function () {
                var settings = {
                    columns: [
                        {id: 'label1', field: 'label', name: 'Название', width: 250},
                        {id: 'path1', field: 'path', name: 'Путь', width: 650}
                    ],
                    options: {
                        enableCellNavigation: true,
                        enableColumnReorder: false,
                        enableFilter: true,
                        url: 'CampaignManager/clientListFetch',
                        params: {
                            campaign_id: campaign_id
                        }
                    }
                };
                $(".x-campaign-clients-tools").click(function (e) {
                    var action = $(e.target).data('action');
                    if (action) {
                        Clients.tools[action] && Clients.tools[action]();
                    }
                });
                Clients.grid = new SlickInfinite("#CampaignManager_clients_sg", settings);
            },
            load: function () {
                Clients.grid;
            },
            tools: {
                reload: function () {
                    Clients.grid.reload();

                }
            }
        };
        var Bonuses = {
            init: function () {
                $("#CampaignManager_bonuses_add").click(function () {
                    Bonuses.add();
                });
                $(".CampaignManager_bonuses_delete").click(function () {
                    if (!confirm("Удалить расчет бонуса?")) {
                        return;
                    }
                    var campaign_bonus_id = $(this).data('campaign_bonus_id');
                    Bonuses.remove(campaign_bonus_id);
                });
                $(".CampaignManager_bonuses_reload").click(function () {
                    var campaign_bonus_id = $(this).data('campaign_bonus_id');
                    Bonuses.periodsLoad(campaign_bonus_id);
                });

                for (let bonus of Campaign.data.bonuses) {
                    Bonuses.periodsLoad(bonus.campaign_bonus_id).done(function () {
                        Bonuses.periodsCardsIntoView(bonus.campaign_bonus_id);
                    });
                }
            },
            add: function () {
                $.post("CampaignManager/bonusAdd", {campaign_id: campaign_id}, function () {
                    Campaign.get();
                });
            },
            remove: function (campaign_bonus_id) {
                $.post("CampaignManager/bonusRemove", {campaign_bonus_id: campaign_bonus_id}, function () {
                    Campaign.get();
                });
            },
            update: function (field, value, title, campaign_bonus_id) {
                if (field === 'campaign_start_at' || field === 'campaign_finish_at') {
                    let now_year = new Date().getFullYear();
                    let needed_year = value.substring(0, 4);
                    let diff = Math.abs(now_year - needed_year);
                    if (diff > 3) {
                        App.flash("Слишком большой период: " + title);
                        return;
                    }
                }
                $.post("CampaignManager/bonusUpdate", {campaign_bonus_id: campaign_bonus_id, field: field, value: value}, function (ok) {
                    if (ok * 1) {
                        App.flash("Сохранено: " + title);
                        if (field.indexOf('bonus_type') > -1 || field.indexOf('campaign_queue') > -1) {
                            Campaign.get();
                        } else {
                            Bonuses.periodsLoad(campaign_bonus_id);
                        }
                    } else {
                        App.flash("Ошибка сохранения: " + title);
                    }
                });
            },
            periodsLoad: function (campaign_bonus_id) {
                return $.post("CampaignManager/bonusCalculate", {campaign_bonus_id: campaign_bonus_id}, function (resp) {
                    var periodsCardData = App.json(resp);
                    Bonuses.periodsRender(campaign_bonus_id, periodsCardData);
                });
            },
            periodsRender: function (campaign_bonus_id, periodsCardData) {
                var period_cards_holder = `#CampaignManager_bonus_period_cards-${campaign_bonus_id}`;
                var tpl = $("#CampaignManager_bonus_periods_tpl").html();
                $(period_cards_holder).html(Mark.up(tpl, {period_cards: periodsCardData}));
                $(period_cards_holder + " .is_current-1").css('borderColor', '#Fe6');
                App.setupForm(period_cards_holder, {}, 'use_inp_values').change(function (node) {
                    var campaign_bonus_period_id = this.name.split('--')[1];
                    var field = this.name.split('--')[0];
                    if ($(this).data('skip-update')) {
                        return;
                    }
                    Bonuses.periodsUpdate(field, App.val(this), this.title, campaign_bonus_period_id, campaign_bonus_id);
                });
            },
            periodsCardsIntoView: function (campaign_bonus_id) {
                var period_cards_holder = `#CampaignManager_bonus_period_cards-${campaign_bonus_id}`;
                let current_card = $(period_cards_holder + " .is_current-1");
                if (!current_card.length) {
                    return;
                }
                current_card.parent().scrollLeft(0);
                let card_left = current_card.offset().left - 20;
                let holder_left = current_card.parent().offset().left - 20;
                current_card.parent().scrollLeft(card_left - holder_left);
            },
            periodsUpdate: function (field, value, title, campaign_bonus_period_id, campaign_bonus_id) {
                $.post("CampaignManager/bonusPeriodUpdate", {campaign_bonus_period_id: campaign_bonus_period_id, field: field, value: value}, function (ok) {
                    if (ok * 1) {
                        Bonuses.periodsLoad(campaign_bonus_id);
                        App.flash("Сохранено: " + title);
                    } else {
                        App.flash("Ошибка сохранения: " + title);
                    }
                });
            }
        };
        return {
            init: init
        };
    })(jQuery);
</script>
<script id="CampaignManager_bonus_periods_tpl" type = "text/html">
    {{if period_cards}}
    {{period_cards}}
    <div style=""  class="is_current-{{is_current}}" id="campaignBonusPeriodId_{{campaign_bonus_period_id}}">
        <div style="height: 30px;font-size: 16px;padding: 4px;">
            {{if period_year|more>0}}
            {{if period_month|more>0 }}
            {{period_month|month|blank>}}

            {{else}}
            <b>{{period_quarter|quarter}}</b>
            {{/if}}
            {{period_year}}г 

            {{else}}
            {{campaign_start_at|chop>10}} &Gt; {{campaign_finish_at|chop>10}}
            {{/if}}
        </div>
        <div>
            <div class="bonus-period-grid">
                <div>База бонуса:</div><div>{{bonus_base}}</div><div></div>
                <div>Результат:</div><div>{{bonus_result}}</div><div></div>
                <div>План I:</div>
                <div><input pattern="\d+" name="period_plan1--{{campaign_bonus_period_id}}" value="{{period_plan1|numberClear}}" placeholder="сумма"></div>
                <div><input pattern="\d+" name="period_reward1--{{campaign_bonus_period_id}}" value="{{period_reward1|numberClear}}" placeholder="премия"></div>
                {{if period_plan1|more>0}}
                <div>План II:</div>
                <div><input pattern="\d+" name="period_plan2--{{campaign_bonus_period_id}}" value="{{period_plan2|numberClear}}" placeholder="сумма"></div>
                <div><input pattern="\d+" name="period_reward2--{{campaign_bonus_period_id}}" value="{{period_reward2|numberClear}}" placeholder="премия"></div>
                {{if period_plan2|more>0}}
                <div>План III:</div><div><input pattern="\d+" name="period_plan3--{{campaign_bonus_period_id}}" value="{{period_plan3|numberClear}}" placeholder="сумма"></div>
                <div><input pattern="\d+" name="period_reward3--{{campaign_bonus_period_id}}" value="{{period_reward3|numberClear}}" placeholder="премия"></div>
                {{/if}}
                {{/if}}
            </div>
            <hr>
            <div id="bonus_chart-{{campaign_bonus_period_id}}">
                {{if period_percent1}}
                План I {{period_percent1}}%
                <div class="card-bar" style="border: 1px solid greenyellow">
                    <div style="max-width:{{period_percent1}}%;background-color: greenyellow"></div>
                </div>
                {{/if}}
                {{if period_percent2}}
                План II {{period_percent2}}%
                <div class="card-bar" style="border: 1px solid orange">
                    <div style="max-width:{{period_percent2}}%;background-color: orange"></div>
                </div>
                {{/if}}
                {{if period_percent3}}
                План III {{period_percent3}}%
                <div class="card-bar" style="border: 1px solid blueviolet">
                    <div style="max-width:{{period_percent3}}%;background-color: blueviolet"></div>
                </div>
                {{/if}}
            </div>

            {{if bonus_type|equals>PAYMENT}}
            <form method="GET" action="./CampaignManager/campaignDetailedView" target="_new">
                <select name="group_by" style="width:70px" data-skip-update="1">
                    <option value="company_id">Клиент</option>
                    <option value="trans_id">Всё</option>
                </select>
                <input type="hidden" name="campaign_bonus_id" value="{{campaign_bonus_id}}">
                <input type="hidden" name="campaign_bonus_period_id" value="{{campaign_bonus_period_id}}">
                <button>Отчет</button>
            </form>
            {{else}}
            <form method="GET" action="./CampaignManager/campaignDetailedView" target="_new">
                <select name="group_by" style="width:70px" data-skip-update="1">
                    <option value="company_id">Клиент</option>
                    <option value="doc_entry_id">Всё</option>
                    <option value="analyse_brand">Бренд</option>
                    <option value="analyse_type">Тип</option>
                    <option value="product_code">Код</option>
                </select>
                <input type="hidden" name="campaign_bonus_id" value="{{campaign_bonus_id}}">
                <input type="hidden" name="campaign_bonus_period_id" value="{{campaign_bonus_period_id}}">
                <button>Отчет</button>
            </form>
            {{/if}}
            {{if bonus_type|equals>PROFIT}}
            <form method="GET" action="./CampaignManager/bonusPeriodBreakEvenRecalculate" target="_new">
                <input type="hidden" name="campaign_bonus_period_id" value="{{campaign_bonus_period_id}}">
                <button>&#8635; Порог рент.</button>
            </form>
            {{/if}}
            {{if period_plan1|equals>0}}
            <hr>
            <button data-button_period_id="{{campaign_bonus_period_id}}" data-campaign_bonus_id="{{campaign_bonus_id}}" title="Скопировать предыдущий период"><img src="img/copy.png"> Повторить</button>
            {{/if}}
        </div>
    </div>
    {{/period_cards}}
    {{else}}
    <div style="width:200px">
        <div><h2>Пока еще кампания не настроена полностью</h2></div>
        <div>Возможно форма расчета не заполнена полностью или не выбраны клиенты, по продажам которых расчитывается мотивация.</div>
    </div>
    {{/if}}
</script>
<script id="CampaignManagerCharts_tpl" type = "text/html">
    <div  style="display:grid;width: 100%;grid-template-columns:150px 150px 150px 150px">
        <div>Клиентов за месяц:</div>
        <div> <b>{{client_count}}</b></div>
        <div></div>
        <div></div>


        <div>Накладных за месяц:</div>
        <div> <b>{{invoice_count}}</b></div>
        <div></div>
        <div></div>


        <div>Общий результат:</div>
        <div> <b>{{total_result|format}}</b></div>
        <div></div>
        <div></div>
    </div>
</script>
<div style="padding: 10px;">
    <div id="CampaignManager-tabs-holder"></div>

    <div id="CampaignManager" style="visibility:hidden">

        <div id="camp_manager_form">

            <div class="easyui-panel" title="Настройки Кампании" style="padding:10px">
                <input type="text" title="Название" name="campaign_name">
                <select name="liable_user_id" title="Менеджер">
                    <!--{{staff_list}}-->
                    <option value="{{user_id}}">{{full_name}}</option>
                    <!--{{/staff_list}}-->
                </select>
                <input type="text" title="Ставка" name="campaign_fixed_payment">
                <hr>
                <div id="CampaignManagerCharts"></div>
                <hr>
                <button id="Campaign_delete_btn"><img src="img/delete.png"> Удалить Кампанию</button>
            </div>
            <div class="easyui-panel" title="Расчет бонусов Кампании">
                <select name="visibility_filter" title="Показывать кампании">
                    <option value="0">Только Архив</option>
                    <option value="1" selected="selected">Все Aктивные</option>
                    <option value="-2">Только для виджета</option>
                </select>
                <hr>
                {{bonuses}}
                <div class=" leftcol-grid">
                    <div style="padding: 5px">
                        <fieldset>
                            <input type="number" name="campaign_queue-{{campaign_bonus_id}}" title="Порядковый №">
                            <select name="bonus_type-{{campaign_bonus_id}}" title="Вид бонуса" required>
                                <option value="VOLUME">Бонус с объема</option>
                                <option value="PROFIT">Бонус с наценки</option>
                                <option value="PAYMENT">Бонус с оплаты</option>
                            </select>
                            <select name="bonus_visibility-{{campaign_bonus_id}}" title="Видимость" required>
                                <option value="0">Архив</option>
                                <option value="1">Только в этой панели</option>
                                <option value="2">Показать в виджете</option>
                            </select>
                        </fieldset>
                        <fieldset>
                            <legend>Сроки проведения, периодичность</legend>
                            <input type="date" name="campaign_start_at-{{campaign_bonus_id}}" title="Начало" required>
                            <input type="date" name="campaign_finish_at-{{campaign_bonus_id}}" title="Конец" required>
                            <select name="campaign_grouping_interval-{{campaign_bonus_id}}" title="Интервал" required>
                                <option value="NOGROUP" selected="selected">Не группировать</option>
                                <option value="MONTH">Месяц</option>
                                <option value="QUARTER">Квартал</option>
                                <option value="YEAR">Год</option>
                            </select>
                        </fieldset>
                        <!--{{if bonus_type|equals>PAYMENT|falsy}}-->
                        <fieldset>
                            <legend>Товары для расчета бонуса</legend>
                            <select name="product_category_id-{{campaign_bonus_id}}" title="Категор. товара">
                                <option selected="selected">* Все</option>
                                <!--{{stock_categories}}-->
                                <option value="{{branch_id}}">{{label}}</option>
                                <!--{{/stock_categories}}-->
                            </select>
                            <input name="product_brand_filter-{{campaign_bonus_id}}" title="Бренд товара">
                            <input name="product_type_filter-{{campaign_bonus_id}}" title="Тип товара">
                        </fieldset>
                        {{/if}}
                        <fieldset>
                            <legend>Процент бонуса по планам</legend>
                            <input pattern="[\d\.]+" name="campaign_bonus_ratio1-{{campaign_bonus_id}}" title="План I бонус %">
                            <input pattern="[\d\.]+" name="campaign_bonus_ratio2-{{campaign_bonus_id}}" title="План II бонус %">
                            <input pattern="[\d\.]+" name="campaign_bonus_ratio3-{{campaign_bonus_id}}" title="План III бонус %">
                        </fieldset>
                        <div>
                            <button class="CampaignManager_bonuses_delete" data-campaign_bonus_id="{{campaign_bonus_id}}"><img src="img/delete.png" style="width:16px"> Удалить расчет</button>
                            <button class="CampaignManager_bonuses_reload" data-campaign_bonus_id="{{campaign_bonus_id}}"><img src="img/reload.png" style="width:16px"> Обновить расчет</button>
                        </div>
                    </div>
                    <div class="CampaignManager_bonus_period_cards" id="CampaignManager_bonus_period_cards-{{campaign_bonus_id}}">
                        ...
                    </div>
                </div>
                <hr>
                {{/bonuses}}
                <button id="CampaignManager_bonuses_add"><img src="img/add.png" > Добавить расчет</button>
            </div>
            <div class="easyui-panel leftcol-grid" title="Клиенты Кампании">
                <div>
                    <input type="text" title="Включить группу" name="subject_path_include">
                    <input type="text" title="Исключить группу" name="subject_path_exclude">
                    <select name="subject_manager_include" title="Включить закрепленных" multiple size="6">
                        <!--{{staff_list}}
                        {{if full_name}}
                        -->
                        <option value="{{user_id}}">{{full_name}}</option>
                        <!--{{/if}}
                        {{/staff_list}}-->
                    </select>
                    <select name="subject_manager_exclude" title="Исключить закрепленных" multiple size="6">
                        <!--{{staff_list}}
                        {{if full_name}}
                        -->
                        <option value="{{user_id}}">{{full_name}}</option>
                        <!--{{/if}}
                        {{/staff_list}}-->
                    </select>
                </div>
                <div  style="max-width:920px;">
                    <div class="x-campaign-clients-tools" style="display:grid;grid-template-columns: auto auto;">
                        <div style="font-weight: bold;padding-top: 8px;">
                            <img src="img/table16.png" style="width:16px;height: 16px;"> Список клиентов
                        </div>
                        <div style="text-align: right">
                            <span class="icon-24 icon-refresh" data-action="reload" title="Обновить"> </span> 
                        </div>                    
                    </div>
                    <div id="CampaignManager_clients_sg" style="height: 300px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<style>
    .leftcol-grid{
        display: grid;
        grid-template-columns: 340px auto;
    }
    .bonus-range-grid{
        display: grid;
        grid-gap:5px;
        grid-template-columns: auto auto auto auto auto auto auto auto;
    }
    .bonus-period-grid{
        display: grid;
        grid-gap:5px;
        grid-template-columns: auto auto auto;
    }
    .bonus-period-grid div{
        text-align: right;
        display:table-cell;
        vertical-align:middle;
        height: 20px;
    }
    .leftcol-grid input, .leftcol-grid select{
        -width: 200px;
        padding: 3px;
    }
    .leftcol-grid input{
        padding: 4px;
    }
    .CampaignManager_bonus_period_cards {
        display: flex;
        -flex-wrap: wrap;
        height: 365px;
        overflow-x: auto;
    }
    .CampaignManager_bonus_period_cards>div{
        flex: 1;
        max-width: 100%;
        object-fit: cover;
        margin: 5px;
        -background-color: rgba(255,255,255,.3);
        background-image: url(img/window-bg.png);
        border:4px solid #bcf;
    }
    .CampaignManager_bonus_period_cards>div>div:first-child{
        min-width: 230px;
        background-color: rgba(255,255,255,1);
    }
    .CampaignManager_bonus_period_cards>div>div{
        padding: 5px;
    }
    .CampaignManager_bonus_period_cards input{
        width:60px;
        text-align: right;
    }
    .CampaignManager_bonus_period_cards .card-bar>div{
        height: 15px;
        opacity: 0.6;
    }
    #CampaignManager fieldset{
        width: auto;
    }
    hr{
        height: 1px;
        color: #fff;
    }
</style>

