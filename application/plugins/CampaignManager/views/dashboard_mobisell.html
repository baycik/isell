<div class="ui header">Статистика продаж за месяц</div>
<div>
    <div class="ui three top attached buttons" id="CampaignTimespanSelector">
        <button class="ui button" data-timespan="current">Текущий месяц</button>
        <button class="ui button" data-timespan="past">Прошлый месяц</button>
        <button class="ui button" data-timespan="past-past">Позапрошлый месяц</button>
    </div>
    <div id="CampaignStat" class="ui attached segment covert">
        <div class="ui gray image label" style="margin: 3px">
            <i class="icon time alternate"></i><div class="detail">{{month|month}} {{year}}</div>
        </div>
        <div class="ui gray image label" style="margin: 3px">
            <i class="icon user alternate"></i> Клиентов за месяц <div class="detail">{{client_count}}</div>
        </div>
        <div class="ui gray image label" style="margin: 3px">
            <i class="icon file alternate"></i> Накладных за месяц <div class="detail">{{invoice_count}}</div> 
        </div>
        <div class="ui gray image label" style="margin: 3px">
            <i class="icon money"></i> Общий результат <div class="detail">{{total_result|format}}</div> 
        </div>
    </div>
</div>

<div class="ui header">Мотивации</div>
<div id="CampaignCharts" class="covert">
    {{campaigns.bonuses}}
    <div class="ui segment grid stackable">
        <div class="six wide column">
            <b>
            {{campaign_name}} / 
            {{current_result}}
                {{product_category_label|blank>*}} {{product_brand_filter|blank>*}} {{product_type_filter|blank>*}} {{product_class_filter|blank>*}}
            {{/current_result}}
            </b>
            <canvas id="campaign-chart{{current_result.0.campaign_bonus_id}}" style="width: 100%"></canvas>
        </div>
        <div class="ten wide column">
            <table class="ui celled compact table unstackable" style="">
                <!--{{current_result}}-->
                <tbody>
                    <tr>
                        <td style="width:150px;">Период:</td>
                        <td>
                            {{if period_year|more>0}}
                            {{if period_month|more>0 }}
                            {{period_month|month|blank>}}
                            {{else}}
                            <b>{{period_quarter|quarter}}</b>
                            {{/if}}
                            {{period_year}}г
                            {{else}}
                            {{campaign_start_at|chop>10}} &Gt; {{campaign_finish_at|chop>10}}
                            {{/if}}
                        </td>
                    </tr>
                    <tr>
                        <td>База начисления:</td>
                        <td>
                            {{if bonus_type|equals>VOLUME}}Оборот{{/if}}
                            {{if bonus_type|equals>FRACTION}}Доля в обороте{{/if}}
                            {{if bonus_type|equals>PROFIT}}Наценка{{/if}}
                            {{if bonus_type|equals>PAYMENT}}Оплата{{/if}}
                        </td>
                    </tr>
                    <tr>
                        <td>Группа товара:</td>
                        <td>
                            {{if product_category_label}}
                                Категория: {{product_category_label}}
                            {{/if}}
                            {{if product_brand_filter}}
                                Бренд: {{product_brand_filter}}
                            {{/if}}
                            {{if product_type_filter}}
                                Тип: {{product_type_filter}}
                            {{/if}}
                            {{if product_class_filter}}
                                Класс: {{product_class_filter}}
                            {{/if}}
                        </td>
                    </tr>
                    <tr>
                        <td>
                        {{if bonus_type|equals>FRACTION}}
                            Доля в обороте
                        {{else}}
                            Сумма
                        {{/if}}:
                        </td>
                        <td>
                            {{if bonus_type|equals>VOLUME}}
                                {{bonus_base|format}}
                            {{/if}}
                            {{if bonus_type|equals>FRACTION}}
                                {{bonus_base|format}}%
                            {{/if}}
                            {{if bonus_type|equals>PROFIT}}
                                {{bonus_base|percent}} баллов
                            {{/if}}
                            {{if bonus_type|equals>PAYMENT}}
                                {{bonus_base|format}}
                            {{/if}}
                            
                        </td>
                    </tr>

                    <tr>
                        <td><i class="icon circle" style="color:rgba(100,240,100)"></i>
                            {{if bonus_type|equals>PROFIT}}
                            Балл=<b>{{campaign_bonus_ratio1}}</b>:
                            {{else}}
                            План I (
                                {{if period_reward1|more>0}}
                                    {{period_reward1}}
                                {{else}}
                                    {{campaign_bonus_ratio1}}%
                                {{/if}}):
                            {{/if}}
                        </td>
                        <td>{{if period_plan1|more>0}} 
                            
                                {{if bonus_type|equals>PROFIT}}
                                    {{period_plan1|percent}}
                                {{else}}
                                    {{period_plan1|format}}
                                {{/if}}
                            
                            {{else}} без ограничений {{/if}}</td>
                    </tr>
                    <!--{{if period_plan2|more>0}}-->
                    <tr>
                        <td><i class="icon circle" style="color:rgba(100,230,255)"></i>
                            {{if bonus_type|equals>PROFIT}}
                            Балл=<b>{{campaign_bonus_ratio2}}</b>:
                            {{else}}
                            План II (
                                {{if period_reward2|more>0}}
                                    {{period_reward2}}
                                {{else}}
                                    {{campaign_bonus_ratio2}}%
                                {{/if}}):
                            {{/if}}
                        </td>
                        <td>
                            {{if bonus_type|equals>PROFIT}}
                                {{period_plan2|percent}}
                            {{else}}
                                {{period_plan2|format}}
                            {{/if}}
                        </td>
                    </tr>
                    <!--{{if period_plan3|more>0}}-->
                    <tr>
                        <td><i class="icon circle" style="color:rgba(100,100,255)"></i>
                            {{if bonus_type|equals>PROFIT}}
                            Балл=<b>{{campaign_bonus_ratio3}}</b>:
                            {{else}}
                            План III (
                                {{if period_reward3|more>0}}
                                    {{period_reward3}}
                                {{else}}
                                    {{campaign_bonus_ratio3}}%
                                {{/if}}):
                            {{/if}}
                        </td>
                        <td>
                            {{if bonus_type|equals>PROFIT}}
                                {{period_plan3|percent}}
                            {{else}}
                                {{period_plan3|format}}
                            {{/if}}
                        </td>
                    </tr>
                    <!--{{/if}}-->
                    <!--{{/if}}-->
                    <tr>
                        <td>Результат:</td>
                        <td>
                            {{bonus_result|format}}
                        </td>
                    </tr>
                </tbody>
                <!--{{/current_result}}-->
            </table>
        </div>
    </div>
    {{/campaigns.bonuses}}
</div>
<script>
App.dashboardCampaigns = {
    init: function () {
        if( App.user.props.user_level>1 ){

            App.dashboardCampaigns.campaigns.load();
            App.dashboardCampaigns.statistics.load();
        }
        $("#CampaignTimespanSelector").click(function(e){
            var timespan=$(e.target).data('timespan');
            if( !timespan || timespan===App.dashboardCampaigns.timespan ){
                return;
            }
            App.dashboardCampaigns.timespan=timespan;
            App.dashboardCampaigns.campaigns.load();
            App.dashboardCampaigns.statistics.load();
        });
    },
    campaigns: {
        scriptDeffered:{},
        load: function () {
            let url="https://cdn.jsdelivr.net/npm/chart.js@2.8.0/dist/Chart.min.js";
            this.scriptDeffered=$.ajax({url: url,dataType: "script",cache: true,async:true});
            $.post("../CampaignManager/bonusCalculatePersonal/",{timespan:App.dashboardCampaigns.timespan}, function (resp) {
                var personal_bonuses = App.json(resp);
                if (!personal_bonuses || !personal_bonuses.bonuses.length) {
                    $("#CampaignCharts").html("<h2>Нет кампаний</h2>").removeClass('covert');
                    return;
                }
                App.dashboardCampaigns.statistics.stat.total_result=personal_bonuses.total;
                App.dashboardCampaigns.statistics.render();
                App.dashboardCampaigns.campaigns.render(personal_bonuses);
            });
        },
        render: function (personal_bonuses) {
            Mark.pipes.month = function (index) {
                return ['', 'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'][index];
            };
            Mark.pipes.quarter = function (index) {
                return ['', 'Iкв', 'IIкв', 'IIIкв', 'IVкв'][index];
            };
            Mark.pipes.percent=function(number){
                return Math.round(number/100);
            }
            Mark.pipes.format=function(number){
                return Number(number).toLocaleString();
            }
            App.renderTpl('CampaignCharts', {campaigns: personal_bonuses});
            for (let i in personal_bonuses.bonuses) {
                App.dashboardCampaigns.campaigns.chartAdd(personal_bonuses.bonuses[i]);
            }
        },
        chartAdd: function (bonus_data) {
            var config = {
                type: 'doughnut',
                data: {
                    labels: ["%", ""],
                    datasets: []
                },
                options: {
                    responsive: true,
                    legend: {
                        display: false
                    },
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            };
            config.data.datasets = App.dashboardCampaigns.campaigns.chartDatasetCalc(bonus_data);
            let chart_id = "#campaign-chart" + bonus_data.current_result[0].campaign_bonus_id;
            App.dashboardCampaigns.campaigns.scriptDeffered.done(function(){
                new Chart($(chart_id)[0].getContext('2d'), config);
            });
        },
        chartDatasetCalc: function (bonus_data) {
                var doughnut1=0,doughnut2=0,doughnut3=0;
                if(bonus_data){
                    doughnut1 = this.chartDatasetCalcArc(bonus_data.current_result[0], 1);
                    doughnut2 = this.chartDatasetCalcArc(bonus_data.current_result[0], 2);
                    doughnut3 = this.chartDatasetCalcArc(bonus_data.current_result[0], 3);
                }
            return [
                {data: [doughnut3, 100 - doughnut3], backgroundColor: ['#06f', '#ffffff66'], label: 'План I'},
                {data: [doughnut2, 100 - doughnut2], backgroundColor: ['#0dd', '#ffffff66'], label: 'План II'},
                {data: [doughnut1, 100 - doughnut1], backgroundColor: ['#3c3', '#ffffff66'], label: 'План III'}
            ];
        },
        chartDatasetCalcArc: function (arc_data, i) {
            if(arc_data && arc_data['period_plan' + i]>0){
                return Math.round( Math.min(arc_data.bonus_base / arc_data['period_plan' + i] || 0.01,1) * 100);
            } else {
                return 100;
            }
            return null;
        }
    },
    statistics:{
        stat:{
            client_count:0,
            invoice_count:0,
            total_result:0
        },
        load:function(){
            $.post("../CampaignManager/dashboardManagerStatistics/",{timespan:App.dashboardCampaigns.timespan}, function (resp) {
                var stat = App.json(resp);
                if (!stat) {
                    $("#CampaignCharts").html("<h2>Нет кампаний</h2>");
                    return;
                }
                App.dashboardCampaigns.statistics.stat.client_count=stat.client_count;
                App.dashboardCampaigns.statistics.stat.invoice_count=stat.invoice_count;
                App.dashboardCampaigns.statistics.stat.month=stat.month;
                App.dashboardCampaigns.statistics.stat.year=stat.year;
                App.dashboardCampaigns.statistics.render();
            });
        },
        render:function(){
            App.renderTpl('CampaignStat',this.stat);
        }
    }
};
$(App.dashboardCampaigns.init);
</script>