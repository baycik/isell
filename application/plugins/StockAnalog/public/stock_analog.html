<script type="text/javascript">
    /* global App */
    App.StockAnalog_stock_analog={
	init:function(){

            App.StockAnalog_stock_analog.table.init();
        },
        link:function( product_id ){
            var selected_rows = App.StockAnalog_stock_analog.table.grid.getSelectedRows();
            if (selected_rows.length>0) {
                let product_ids=[];
                for(let row_num of selected_rows){
                    let row=App.StockAnalog_stock_analog.table.grid.getDataItem(row_num);
                    if( row.product_id==product_id ){
                        continue;
                    }
                    product_ids.push(row.product_id);
                    console.log(row);
                }
                if(!product_ids.length){
                    return;
                }
                $.post("StockAnalog/link_bulk_by_id",{product_id:product_id,product_ids2:JSON.stringify(product_ids)},function( ok ){
                        if( ok==1 ){
                            App.flash("Товар добавлен в группу аналогов");
                        }
                        if( ok=='product_not_found' ){
                            App.flash("Товар с кодом '"+product_code+"'не найден!");
                        }
                        if( ok=='product_duplicate' ){
                            App.flash("Укажите код аналога для связи товаров!");
                        }
                        App.StockAnalog_stock_analog.table.grid.reload();
                    });
            } else {
                var product_code=prompt("Введите код аналога");
                if( product_code ){
                    $.post("StockAnalog/link",{product_id:product_id,product_code:product_code},function( ok ){
                        if( ok==1 ){
                            App.flash("Товар добавлен в группу аналогов");
                        }
                        if( ok=='product_not_found' ){
                            App.flash("Товар с кодом '"+product_code+"'не найден!");
                        }
                        if( ok=='product_duplicate' ){
                            App.flash("Укажите код аналога для связи товаров!");
                        }
                        App.StockAnalog_stock_analog.table.grid.reload();
                    });
                }
            }
        },
        unlink:function( product_id ){
            $.post("StockAnalog/unlink",{product_id:product_id},function( ok ){
                if( ok==1 ){
                    App.flash("Товар удален из группы аналогов");
                }
                App.StockAnalog_stock_analog.table.grid.reload();
            });
        },
        showgroup:function(analog_group_tag){
            var filter={analog_group_tag:analog_group_tag};
            App.StockAnalog_stock_analog.table.grid.setFilter(filter);
        },
        table:{
            current_id: '',
            list:[],
            init: function(){
                var settings = {
			columns:  [
                            {id: "analog_group_tag", field: "analog_group_tag",sortable: true, name: "Группа",  width: 70,formatter:App.StockAnalog_stock_analog.table.frm.color},
                            {id: "label", field: "label",sortable: true, name: "Категория",  width: 100},
                            {id: "product_code", field: "product_code",sortable: true, name: "Код",  width: 120},
                            {id: "product_name", field: "product_name",sortable: true, name: "Название",  width: 600},
                            {id: "product_price", field: "product_price",sortable: true, name: "Цена", cssClass: 'slick-align-right',  width: 50,formatter:App.StockAnalog_stock_analog.table.frm.diff},
                            {id: "product_quantity", field: "product_quantity",sortable: true, name: "Остаток", cssClass: 'slick-align-right',  width: 70},
                            {id: "action_link", field: "action_link",sortable: true, name: "Привязать", cssClass: 'slick-align-center',  width: 40,formatter:App.StockAnalog_stock_analog.table.frm.link},
                            {id: "action_unlink", field: "action_unlink", name: "Отвязать", cssClass: 'slick-align-center',  width: 40,formatter:App.StockAnalog_stock_analog.table.frm.unlink}
                        ],
			options: {
			    editable: true,
                            enableCellNavigation: true,
                            enableColumnReorder: false,
                            enableFilter: true,
                            multiSelect: true,
			    url: 'StockAnalog/listFetch/'
			}
		    };
                    
		    App.StockAnalog_stock_analog.table.grid = new SlickInfinite("#analog_list_sg", settings);
                    App.StockAnalog_stock_analog.table.grid.onClick.subscribe(function (e, data) {
                        var row_data=App.StockAnalog_stock_analog.table.grid.getDataItem(data.row);
                        var stockanalog_id=0;
                        if(row_data){
                            stockanalog_id=row_data.stockanalog_id;
                        }
		    });
                    App.StockAnalog_stock_analog.table.grid.onDblClick.subscribe(function (e, data) {
			var focus='';
			try{
			    focus=App.StockAnalog_stock_analog.table.grid.getColumns()[data.cell].field;
			} catch(e){
			    
			}
			App.StockAnalog_stock_analog.table.tools.entryEdit(focus);
		    });
                    $(".x-stockanalog-tools").click(function (e) {
                        var action = $(e.target).data('action');
                        if (action) {
                            App.StockAnalog_stock_analog.table.tools[action] && App.StockAnalog_stock_analog.table.tools[action]();
                        }
                    });
            },
            tools:{
                doimport:function(){
		    var config = [
			{field: "product_code1", name: "Код товара", required: true},
			{field: "product_code2", name: "Код аналога", required: true}
		    ];
		    App.loadWindow('page/dialog/importer', {label: 'analog', fields_to_import: config}).progress(function (status, fvalue, Importer) {
			if (status === 'submit') {
                            App.post("StockAnalog/import/", fvalue, function (ok) {
                                App.flash("Импортировано " + ok);
                                Importer.reload();
                                App.StockAnalog_stock_analog.table.grid.reload();
                            });
			}
		    });
                },
                doexport:function(){
                    $.post("StockAnalog/export/",function(ok){
                        if(ok){
                            App.flash("Экспортировано "+ok);
                            var config = [
                                {field: "product_code1", name: "Код товара", required: true},
                                {field: "product_code2", name: "Код аналога", required: true}
                            ];
                            App.loadWindow('page/dialog/importer', {label: 'analog', fields_to_import: config}).progress(function (status, fvalue, Importer) {
                                if (status === 'submit') {
                                    App.post("StockAnalog/import/", fvalue, function (ok) {
                                        App.flash("Импортировано " + ok);
                                        Importer.reload();
                                        App.StockAnalog_stock_analog.table.grid.reload();
                                    });
                                }
                            });
                        }
                    });
                },
                entryEdit: function (focus) {
                    var selected_rows = App.StockAnalog_stock_analog.table.grid.getSelectedRows();
                    if (!selected_rows.length) {
                        App.flash("Ни одна строка не выбрана!");
                        return;
                    }
                    var row_data=App.StockAnalog_stock_analog.table.grid.getDataItem(selected_rows[0]);
                    if( row_data ){
                        row_data.focus=focus;
                        App.StockAnalog_stock_analog.table.showProductCard(row_data);
                    }
                }
            },
            showProductCard: function (fvalue) {
		if (App.user.props.user_level < 2) {
		    alert("Доступ ограничен");
		    return;
		}
		fvalue.enablePrevnext = true;
		App.loadWindow('page/stock/product_card', fvalue).progress(function (status, fvalue) {
		    if (status === 'save') {
			App.StockAnalog_stock_analog.table.grid.reload();
		    }
		    if (status === 'prev') {
			App.StockAnalog_stock_analog.table.prev();
		    }
		    if (status === 'next') {
			App.StockAnalog_stock_analog.table.next();
		    }
		});
	    },
            prev:function(){
		if( App.StockAnalog_stock_analog.table.grid.navigateUp() ){
		    App.StockAnalog_stock_analog.table.tools.entryEdit();
		}
	    },
	    next:function(){
		if( App.StockAnalog_stock_analog.table.grid.navigateDown() ){
		    App.StockAnalog_stock_analog.table.tools.entryEdit();
		}
	    },
            frm: {
                link:function(row, cell, value, columnDef, dataContext){
                    return '<div  onclick="event.stopPropagation()"><a href="javascript:App.StockAnalog_stock_analog.link('+dataContext.product_id+')">➕</a></div>';
                    
                },
                unlink:function(row, cell, value, columnDef, dataContext){
                    return '<a href="javascript:App.StockAnalog_stock_analog.unlink('+dataContext.product_id+')">➖</a>';
                },
                color:function(row, cell, value, columnDef, dataContext){
                    return `<div style="background-color:#${value};height:23px;cursor:pointer" onclick="App.StockAnalog_stock_analog.showgroup('${value}')"></div>`;
                },
                diff:function(row, cell, value, columnDef, dataContext){
                    var color='';
                    if( dataContext.diff>0 ){
                        color="#ff06";
                    }
                    return `<div style="background-color:${color};border-radius:5px">${value}</div>`;
                }
            }
        }
    };
</script>
<div style="width:1100px;margin: auto;">
    <div class="x-stockanalog-tools" style="text-align: right;">
        <span data-action="doexport" class="icon-24 icon-export" title="Экспортировать"> </span>
        <span data-action="doimport" class="icon-24 icon-import" title="Импортировать"> </span>
        <span class="icon-24 icon-refresh" title="Обновить" onclick="App.StockAnalog_stock_analog.table.grid.reload()"></span>
    </div>
    <div style="height: 600px;" id="analog_list_sg"></div>
</div>