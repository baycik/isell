<script>
    App.stock = {
        init: function () {
            App.title("Каталог товаров");
            App.stock.head.init();
            App.stock.cart.init();
            App.stock.entries.init();
            App.stock.filter.init();
            App.stock.utils.initControls();
            App.Topic('passiveCompanySelected').subscribe(function () {
                App.stock.entries.load();
            });
        },
        focus: function () {
            App.title("Каталог товаров");
            App.stock.cart.setTotal();
            App.stock.entries.show_cart = false;
            //App.stock.entries.load();//to not to reset loaded entries when returned to this page
        },
        render: function (){
        },
        head: {
            init: function(){
                App.stock.head.pcompInit();
                App.stock.categories.init();
                $('.limit-dropdown').dropdown({
                    onChange: function (value){
                        App.stock.entries.parameters.limit=value;
                        App.stock.entries.load();
                    }
                });
                $('.order-by-dropdown').dropdown({
                    onChange: function (value){
                        App.stock.entries.parameters.order_by=value;
                        App.stock.entries.load();
                    }
                });
            },
            pcompInit: function () {
                $('.pcomp_id').dropdown({
                    apiSettings: {
                        url: 'compListFetch/'
                    },
                    fields: {
                        value: 'company_id',
                        name: 'label',
                        text: 'label'
                    },
                    filterRemoteData: true,
                    fullTextSearch: true,
                    onChange: function (value, text, $choice) {
                        if (value * 1 > 0) {
                            App.user.pcompSelect({company_id: value, label: text});
                        } else {
                            $(".pcomp_id").dropdown('set text', "Выберите клиента");
                            $(".pcomp_id").dropdown('show');
                        }
                    }
                }).dropdown("set text", App.user.pcomp.label || '');
                if( App.user.pcomp ){
                    
                }
            },
            clearSearchbar: function () {
                App.stock.entries.show_cart = 0;
                $("#stock_search_input").val('');
                App.stock.entries.load();
            }
            
        },
        categories: {
            list: [],
            init: function (){
                App.stock.categories.load();
            },
            load: function () {
                var params = {
                    id: 0,
                    depth: "3"
                };
                $.get("../Stock/branchFetch", params, function (response) {
                    App.stock.categories.list = App.json(response);
                    App.stock.categories.render();
                }); 
            },
             render: function () {
                App.renderTpl("categories_container", {categories: App.stock.categories.list});
            },
            find: function(query){
                if(query === ''){
                    App.stock.categories.clearSearchbar();
                    return;
                }
                var result = App.stock.categories.flatten(App.stock.categories.list,query.toLowerCase());
                App.renderTpl("categories_search_container", {categories: result});
                $("#categories_search_container").show();
                $(".categories-container").hide();
                
            },
            flatten: function(array,query){
                var result = [];
                array.forEach(function (a) {
                    if(a.label.toLowerCase().indexOf(query) > -1){
                       result.push(a);
                    }
                    
                    if (Array.isArray(a.children)) {
                        result = result.concat(App.stock.categories.flatten(a.children,query));
                    }
                });
                return result;  
            },
            clearSearchbar: function () {
                $("#categories_search_input").val('');
                $("#categories_search_container").hide();
                $(".categories-container").show();
                
            }
        },
        entries: {
            list: [],
            current_list: [],
            loading_finished: 0,
            parameters:{
                category_id:0,
                show_cart:0,
                order_by: 'popularity,DESC',
                offset: 0,
                limit:12
            },
            init: function(){
                //App.stock.entries.load();
            },
            load_prepare_params:function(load_more){
                if (load_more) {
                    App.stock.entries.parameters.offset += App.stock.entries.parameters.limit;
                } else {
                    App.stock.entries.parameters.offset = 0;
                };
                App.stock.entries.parameters.q=$('#stock_search_input').val();
                App.stock.entries.parameters.filter_selected_grouped=App.restore('filter_selected_grouped');
                
                App.stock.entries.parameters.sortby=App.stock.entries.parameters.order_by.split(',')[0];
                App.stock.entries.parameters.sortdir=App.stock.entries.parameters.order_by.split(',')[1];
                App.stock.entries.parameters.pcomp_id=App.user.pcomp.company_id;
                $('#stock_categories_header').html("");
            },
            load: function (load_more) {
                if ( App.user.pcomp.company_id>0 && App.user.pcomp.company_id!==App.user.acomp.company_id ) {
                    $("#stock_pcomp_notice").hide();
                };
                App.stock.entries.load_prepare_params(load_more);
                
                App.flash("Загрузка товаров...");
                $.post("../Stock/matchesListFetch", App.stock.entries.parameters, function (resp) {
                    App.flash("Загрузка товаров:ОК");
                    var new_loaded_items = App.json(resp);
                    if ( load_more ) {
                        App.stock.entries.list = App.stock.entries.list.concat(new_loaded_items);
                    } else {
                        App.stock.entries.list = new_loaded_items;
                    };
                    
                    App.stock.entries.loading_finished = 0;
                    if ( new_loaded_items.length<App.stock.entries.parameters.limit ) {
                        App.stock.entries.loading_finished = 1;
                    }
                    App.stock.entries.render();
                });
            },
            addSpecailProductFeatures: function () {
                for (var i = 0; i < App.stock.entries.current_list.length; i++) {
                    App.stock.entries.current_list[i].product_quantity = App.stock.cart.findInCart(App.stock.entries.current_list[i].product_id).product_quantity;
                    //App.stock.entries.current_list[i].is_promo = (App.stock.entries.current_list[i].price_final !== App.stock.entries.current_list[i].price_final_raw) ? 1 : 0;
                }
            },
            render: function () {
                if(App.stock.entries.show_cart){
                    $('#stock_list').addClass('cart');
                    $('#stock_head_form .field').addClass('disabled');
                    App.stock.entries.current_list = App.stock.cart.list;
                } else {
                    $('#stock_list').removeClass('cart');
                    $('#stock_head_form .field').removeClass('disabled');
                    App.stock.entries.current_list = App.stock.entries.list;
                }
                var gridview=localStorage.getItem('stockGridView');
                App.stock.filter.load();
                App.stock.entries.addSpecailProductFeatures();
                App.stock.entries.gridViewConfigure(gridview); 
                App.stock.cart.renderButton(); 
                App.renderTpl("stock_list", {products: App.stock.entries.current_list, loading_finished: App.stock.entries.loading_finished, show_cart: App.stock.entries.show_cart});
            }, 
            renderItem: function (index, product_quantity){    
                var item_node = '#product_item_'+index;
                if(product_quantity<1 || !product_quantity){
                    $(item_node + ' .product-clear-button-container').hide();
                    App.stock.entries.render();
                }else{
                    $(item_node).css('background-color','#ffd');
                    $(item_node + ' .minus-button').removeClass('disabled');
                    $(item_node + ' .product-clear-button-container').show();
                    $(item_node + ' .product_quantity').val(product_quantity);
                    $(item_node + ' .product-clear-button').data('delta', product_quantity*-1);
                    if(App.stock.entries.show_cart){
                        $(item_node + ' .product-total').html(App.stock.cart.list[index].product_sum + ' ₽');
                    }
                }
            },
            gridViewConfigure: function(gridview){
                if(gridview>0){
                    $('#stock_list').addClass('grid-view');
                } else {
                    $('#stock_list').removeClass('grid-view');
                }
                return;
            },
            gridViewToggle: function(enable){
                localStorage.setItem('stockGridView',enable);
                App.stock.entries.gridViewConfigure(enable);
                App.stock.entries.render();
            }
        },
        utils: {
            getEntryByCode: function(product_code,array){
                for (var i = 0; i < array.length; i++) {
                    if (product_code == array[i].product_code) {
                        return array[i];
                    };
                };
            },
            initControls: function(){
                $('#stock_render_mode').click(function(e){
                    App.stock.entries.show_cart = $(e.target).data('show_cart');
                    $(e.target).data('show_cart', !App.stock.entries.show_cart);
                    App.stock.entries.render();
                });
                $('#stock_list').change(function(e){
                    var index = $(e.target).data('index');
                    
                    var product_object = App.stock.entries.current_list[index];
                    var new_quantity = e.target.value*1;
                    App.stock.cart.update(product_object,false,new_quantity, index);
                });
                $('#stock_list').click(function(e){
                    var delta = $(e.target).data('delta');
                    var action = $(e.target).data('action');
                    if(delta || action){
                        var index = $(e.target).data('index');
                        var product_object = App.stock.entries.current_list[index];
                        if(action){
                            App.stock.cart.update(product_object,0,product_object.product_quantity*-1, index); 
                            return;
                        } 
                        App.stock.cart.update(product_object,delta,false, index); 
                    }
                    
                });
                $('#stock_category_tree').click(function(e){
                    $('#categoriesPopup').modal({ inverted: true, duration:0}).modal('show');
                });
                $('.limit-dropdown').change(function(e){
                    App.stock.entries.limit = $(this).dropdown('get value')*1;
                    App.stock.entries.load();
                });
                $('#stock_attributes').click(function(e){
                    $('#stock_filter_popup').show();
                    $('#stock_content').hide();
                });
                $('.order-by-dropdown').change(function(e){
                    App.stock.entries.parameters.order_by = $(this).dropdown('get value');
                    App.stock.entries.load();
                });
                $(document).click(function(e){
                    var expand = $(e.target).data('action');
                    if(expand === 'expand_category'){
                       var toggle_id = e.target.parentNode.id;
                       $('#toggle_for_'+toggle_id.split('_')[1]).toggle('fast');
                    }
                    var category_id = $(e.target).data('category_id');
                    if(!category_id && category_id !== '0'){return;};
                    category_id === 'All' ? category_id = 0 : 0;
                    $('#stock_category_tree label.placeholder').html($(e.target).html());
                    App.stock.entries.parameters.category_id = category_id;
                    App.stock.entries.load();
                    $('#categoriesPopup').modal('hide');
                }); 
            }
        },
        cart: {
            list: [],
            total: '0.00',
            init: function(){
                App.stock.cart.restore();
            },
            renderButton: function(){
                App.renderTpl("stock_render_mode", {show_cart: App.stock.entries.show_cart, cart_quantity: App.stock.cart.list.length, total: App.stock.cart.total});
                $('.cart-quantity').html(App.stock.cart.list.length);
            },
            update: function (product_object,delta,new_quantity, index) {
                var founded_product=App.stock.cart.findInCart(product_object.product_id);
                var product_quantity = 0;
                if( !founded_product ){
                    if(!delta && new_quantity<=0){return};
                    product_object.product_quantity = delta || new_quantity;
                    product_quantity = App.stock.cart.add(product_object);
                } else {
                    if( founded_product.product_quantity+delta<=0 && new_quantity<=0 || new_quantity + founded_product.product_quantity<=0 || new_quantity===0 ){
                        product_quantity = App.stock.cart.delete(founded_product.index);
                    } else {
                        product_quantity = App.stock.cart.modify(founded_product.index,delta,new_quantity);
                    }
                }
                App.stock.cart.store();
                App.stock.cart.setTotal();
                App.stock.cart.renderButton();
                App.stock.entries.renderItem(index, product_quantity); 
            },
            delete: function(index){
                
                App.stock.cart.list.splice(index, 1);
                return false;
            },
            add:function(product_object){
                App.stock.cart.list.push(product_object);
                return product_object.product_quantity;
            },
            modify:function(index,delta,new_quantity){
                delta ? App.stock.cart.list[index].product_quantity += delta : App.stock.cart.list[index].product_quantity = new_quantity ;
                return App.stock.cart.list[index].product_quantity;
            },
            setTotal: function(){
                var total = 0;
                for (var i = 0; i < App.stock.cart.list.length; i++) {
                    App.stock.cart.list[i].product_sum = (App.stock.cart.list[i].price_final * App.stock.cart.list[i].product_quantity).toFixed(2);
                    total += App.stock.cart.list[i].product_sum*1 ;
                };
                App.stock.cart.total = total.toFixed(2);
            },
            findInCart: function (product_id) {
                for (var i = 0; i < App.stock.cart.list.length; i++) {
                    if (product_id === App.stock.cart.list[i].product_id) {
                        App.stock.cart.list[i].index=i;
                        return App.stock.cart.list[i];
                    };
                };
                return false;
            },
            store:function(){
                App.store('stock_cart_list',App.stock.cart.list);
            },
            restore:function(){
                var cart_list = App.json(App.restore('stock_cart_list'));
                if(cart_list){
                    App.stock.cart.list = cart_list;
                    App.stock.cart.setTotal();
                };
            },
            createDocument: function () {
                location.hash = "#document.html";
            }
        },
        filter:{
            full_query:null,
            filter_tree: {},
            selected: [],
            last_expanded_filter_group: [],
            init: function () {
                $('#stock_filter_container').accordion({
                    duration: 100,
                    exclusive: false,
                    onOpen: function () {
                        App.stock.filter.last_expanded_filter_group.push( $(this).data('filter_group_id') );
                    },
                    onClose: function () {
                        let expanded=App.stock.filter.last_expanded_filter_group;
                        let index=expanded.indexOf($(this).data('filter_group_id'));
                        if( index>-1 ){
                            expanded.splice(index,1);
                        }
                    }
                });
                $('#stock_filter_container').change(function (e){
                    App.stock.filter.changed(e.target);
                });
                $("#stock_filter_tags").click(function (e) {
                    var filter_option_id = $(e.target).data('filter_option_id');
                    if (filter_option_id) {
                        App.stock.filter.tags.remove(filter_option_id);
                    }
                });
            },
            load: function () {
                let full_query=App.stock.entries.parameters.q+'---'+App.stock.entries.parameters.category_id+'---'+App.stock.entries.parameters.filter_selected_grouped+'---'+App.user.pcomp.company_id;
                if( App.stock.filter.full_query===full_query ){
                    return;
                }
                App.stock.filter.full_query=full_query;
                $.post("../Stock/matchesFilterGet", function (resp) {
                    var filter_tree = App.json(resp);
                    if (filter_tree) {
                        App.stock.filter.render(filter_tree);
                    }
                });
            },
            render: function (filter_tree) {
                App.stock.filter.filter_tree=filter_tree;
                App.renderTpl("stock_filter_container", {filter_tree: filter_tree});
                if( App.stock.filter.last_expanded_filter_group!==undefined ) {
                    let expanded=App.stock.filter.last_expanded_filter_group;
                    for( let filter_group_id of expanded ){
                        $('#stock_filter_group_' + filter_group_id).addClass('active');
                        $('#stock_filter_group_content_' + filter_group_id).addClass('active');
                    }
                }
                $('.stock-attributes-button .attributes-selected-length').html(App.stock.filter.selected.length);
                $("#stock_filter_container input[data-is_selected=1]").prop('checked', 1);

                App.stock.filter.compile();//to actualize checked options that came from server
                App.stock.filter.tags.render();
            },
            range:{
                get:function(node){
                    let filter_group_id=$(node).data('filter_group_id');
                    let found_group=App.stock.filter.find_group_intree(filter_group_id);
                    let minmax=found_group.filter_group_minmax.split('_');
                    let from=$("#stock_filter_container input[data-filter_group_id="+filter_group_id+"][data-value_type=from]").val().replace(/,/g,'.')||minmax[0];
                    let to=$("#stock_filter_container input[data-filter_group_id="+filter_group_id+"][data-value_type=to]").val().replace(/,/g,'.')||minmax[1];
                    let $custom_option=$(`#custom_option_${filter_group_id}`);
                    $custom_option.find('label').html(`${from} - ${to}`);
                    $custom_option.find('input').prop('checked',true);
                    $custom_option.find('input').data('filter_option_range',`${from}_${to}`);
                    $custom_option.show();
                },
                set:function(filter_group_id,filter_option_range){
                    let from='';
                    let to='';
                    if( filter_option_range!==-1 ){
                        from=filter_option_range.split('_')[0];
                        to=filter_option_range.split('_')[1];
                    }
                    let $from=$("#stock_filter_container input[data-filter_group_id="+filter_group_id+"][data-value_type=from]");
                    let $to=$("#stock_filter_container input[data-filter_group_id="+filter_group_id+"][data-value_type=to]");
                    $from.val(from);
                    $to.val(to);
                }
            },
            changed: function ( node ) {
                let is_textbox=($(node).attr('type')==='text');
                if( is_textbox ){
                    App.stock.filter.range.get(node);
                }
                App.stock.filter.compile();
                App.stock.filter.tags.render();
                App.stock.filter.apply();
            },
            compile: function () {
                App.stock.filter.selected_count = 0;
                App.stock.filter.selected=[];
                App.stock.filter.selected_grouped={};
                $("#stock_filter_container input:checked").each(function (index, node) {
                    let filter_group_id = $(node).data('filter_group_id');
                    let filter_option_id = $(node).data('filter_option_id');
                    let filter_option_range = $(node).data('filter_option_range');
                    let option=App.stock.filter.find_option_intree(filter_group_id,filter_option_id);
                    let group_selection=App.stock.filter.selected_grouped[filter_group_id];
                    if( filter_option_range ){
                        App.stock.filter.range.set(filter_group_id,filter_option_range);
                        if( filter_option_range<0 ){//all range selected
                            return;
                        }
                        group_selection=filter_option_range;
                    } else {
                        if( !group_selection ){
                            group_selection = [];
                        }
                        group_selection.push(filter_option_id); 
                    }
                    App.stock.filter.selected_grouped[filter_group_id]=group_selection;
                    App.stock.filter.selected.push(option);
                    App.stock.filter.selected_count++;
                });
                App.store('filter_selected_grouped', App.stock.filter.selected_grouped);
            },
            find_option_intree:function(filter_group_id,filter_option_id){
                let found_group=App.stock.filter.find_group_intree(filter_group_id);
                for (let option of found_group.filter_group_options) {
                    if( option.filter_option_id==filter_option_id ) {
                        option.filter_group_name=found_group.filter_group_name;
                        return option;
                    }
                }
                return null;
            },
            find_group_intree:function(filter_group_id){
                for(let group of App.stock.filter.filter_tree){
                    if( group.filter_group_id === filter_group_id ){
                        return group;
                    }
                }
                return null;
            },
            apply: function () {
                App.stock.filter.load_filtered_entries();
            },
            load_filtered_entries: function () {
                clearTimeout(App.stock.filter.clock);
                App.stock.filter.clock = setTimeout(function () {
                    App.stock.entries.show_cart = false;
                    App.stock.entries.load();
                }, 300);
            },
            clearSelected: function () {
                $("#stock_filter_container input:checked").prop('checked', 0);
                App.stock.filter.changed();
            },
            tags: {
                render: function () {
                    App.renderTpl("stock_filter_tags", {stock_filter_tags: App.stock.filter.selected});
                },
                remove: function (filter_option_id) {
                    //only for responsivness until filter is reloaded
                    for (let i in App.stock.filter.selected) {
                        if (App.stock.filter.selected[i]['filter_option_id'] === filter_option_id) {
                            App.stock.filter.selected.splice(i, 1);
                            break;
                        }
                    }
                    $("#stock_filter_container input[data-filter_option_id=" + filter_option_id + "]").prop('checked', 0);
                    App.stock.filter.changed();
                }
            }
        }
    };
</script>
<style>
    @import "stock.css";
</style>
<div id="stock_container" style="display: grid; grid-template-columns: 25% 75%; grid-column-gap: 1em;">
    <div id="stock_filter_widget">
        <div id="stock_filter_popup" class="ui  segment " style="margin-bottom: auto;">
            <a  class="ui secondary close icon button" style="float:right; display: none" onclick="$('#stock_filter_popup').hide();
                    $('#stock_content').show();"><i class="icon close"></i></a>
            <div class="header" style='padding: 1em;'><h4>Фильтр</h4></div>
            <div class="ui divider"></div>
            <!--TAGS-->
            <div id="stock_filter_tags" class="covert">
                <div class='title' style='margin-bottom: 5px'>
                    {{ if stock_filter_tags}}
                    <b>Выбрано:</b>
                    {{else}}
                    <i>Ничего не выбрано</i>
                    {{/if}}
                </div>
                <div class="ui blue  labels">
                    {{stock_filter_tags}}
                    <a class="ui  label">
                        {{filter_group_name}}: {{filter_option_label}} 
                        <i class="delete icon" data-filter_option_id="{{filter_option_id}}"></i>
                    </a>
                    {{/stock_filter_tags}}
                </div>
            </div>
            <!--/TAGS-->
            <div class="ui divider"></div>
            <div class="ui form" style="padding:1em">
                <div class="ui fields">
                    <div class="sixteen wide field">
                        <button class=" ui floated right blue fluid button" onclick="App.stock.filter.clearSelected()">
                            Сбросить фильтры
                        </button>
                    </div>
                </div>
            </div>
            <div class="ui divider"></div>
            <!--ACCORDION-->
            <div id="stock_filter_container"  class="ui accordion covert">
                {{filter_tree}}
                <div class='filtergroup-container'>
                    <div class="title" id="stock_filter_group_{{filter_group_id}}" >
                        <i class="dropdown icon"></i>
                        {{filter_group_name}}
                    </div>
                    <div class="filter_group_content content" id="stock_filter_group_content_{{filter_group_id}}" data-filter_group_id="{{filter_group_id}}">
                        <div class="ui form">
                            {{if filter_group_minmax}}
                            <RANGEFILTER>
                                <div class="fields">
                                    <div class="field">
                                        <label>От</label>
                                        <input type="text"
                                               pattern="[0-9,\.]+"
                                               placeholder="{{filter_group_minmax|split>_|limit>1>0|join>}}"
                                               data-filter_group_id="{{filter_group_id}}"
                                               data-value_type="from"
                                               onfocus="this.select()">
                                    </div>
                                    <div class="field">
                                        <label>До</label>
                                        <input type="text"
                                               pattern="[0-9,\.]+"
                                               placeholder="{{filter_group_minmax|split>_|limit>1>1|join>}}"
                                               data-filter_group_id="{{filter_group_id}}"
                                               data-value_type="to"
                                               onfocus="this.select()">
                                    </div>
                                </div>
                                <div class="grouped fields" >
                                    <div class="field">
                                        <div class="ui child checkbox">
                                            <input type="radio" 
                                                   id="{{filter_group_id}}__"
                                                   name="{{filter_group_id}}"
                                                   data-filter_group_id="{{filter_group_id}}" 
                                                   data-filter_option_id="0"
                                                   data-filter_option_range="-1"
                                                   >
                                            <label for="{{filter_group_id}}__">
                                                Все
                                            </label>
                                        </div>
                                    </div>
                                    <div class="field" id="custom_option_{{filter_group_id}}" style="display:none">
                                        <div class="ui child checkbox">
                                            <input type="radio" 
                                                   name="{{filter_group_id}}"
                                                   data-filter_group_id="{{filter_group_id}}"
                                                   >
                                            <label></label>
                                        </div>
                                    </div>
                                    {{filter_group_options}}
                                    <div class="field">
                                        <div class="ui child checkbox">
                                            <input type="radio" 
                                                   id="{{filter_option_id}}"
                                                   name="{{filter_group_id}}"
                                                   data-filter_group_id="{{filter_group_id}}" 
                                                   data-filter_option_id="{{filter_option_id}}"
                                                   data-filter_option_range="{{filter_option_range}}"
                                                   data-is_selected="{{is_selected}}"
                                                   >
                                            <label for="{{filter_option_id}}">
                                                {{if match_count|equals>0}}
                                                <span style="color: gray">{{filter_option_label}}</span>
                                                {{else}}
                                                <span>{{filter_option_label}} <span style="color: gray">({{match_count}})</span>
                                                {{/if}}
                                            </label>
                                        </div>
                                    </div>
                                    {{/filter_group_options}}
                                </div>
                            </RANGEFILTER>
                            {{else}}
                            <OPTIONFILTER>
                                {{filter_group_options}}
                                    <div class="field">
                                        <div class="ui child checkbox">
                                            <input type="checkbox" 
                                                   id="{{filter_option_id}}"
                                                   data-filter_group_id="{{filter_group_id}}" 
                                                   data-filter_option_id="{{filter_option_id}}"
                                                   data-is_selected="{{is_selected}}"
                                                   >
                                            <label for="{{filter_option_id}}">
                                                {{if match_count|more>0}}
                                                <span>{{filter_option_label}} <span style="color: gray">({{match_count}})</span>
                                                {{else}}
                                                <span style="color: gray">{{filter_option_label}}</span>
                                                {{/if}}
                                            </label>
                                        </div>
                                    </div>
                                    {{/filter_group_options}}
                            </OPTIONFILTER>
                            {{/if}}
                        </div>  
                    </div>
                </div>
                {{/filter_tree}}
            </div>
            <!--/ACCORDION-->
        </div>
    </div>
    <div id="stock_content">
        <div  class="ui blue segment">
            <form class="ui form" id="stock_head_form">
                <div class="field">
                    <label>Клиент</label>
                    <div class="ui fluid search selection remote dropdown pcomp_id required">
                        <input name="pcomp_id" type="hidden">
                        <i class="dropdown icon"></i>
                        <div class="default text">Выбрать клиента</div>
                        <div class="menu"></div>
                    </div>
                </div>

                <div id="stock_pcomp_notice" class="ui negative message">
                    <i class="ui red exclamation circle icon"></i>
                    Выберите клиента. Цены могут быть не точными.
                </div>

                <div class="fields">
                    <div class="five wide field">
                        <div id='stock_category_tree' class='ui labeled basic gray  icon button'>
                            <i class='bars icon'></i>
                            <label class='placeholder'>Все</label>
                        </div>
                    </div>
                    <div class="stock-attributes-button eight wide field" style="display: none">
                        <div class="ui labeled fluid button">
                            <div id="stock_attributes" class="ui labeled basic icon button">
                                <i class="filter icon"></i>
                                <label class="placeholder">Фильтр</label>
                            </div>
                            <a class="ui basic left pointing label attributes-selected-length"></a>
                        </div>
                    </div>
                    <div id="stock_search" class="eleven wide field">
                            <div class="ui left icon right labeled input fluid" style="margin-bottom: 5px;">
                                <i class="search icon"></i>
                                <input id="stock_search_input" placeholder="Введите название или код..." type="text" style="background-color:#ffd"
                                       oninput="clearTimeout(App.stock.entries.clock);App.stock.entries.clock = setTimeout(function () {App.stock.entries.load()}, 600);">
                                <div class="ui basic label" onclick="App.stock.head.clearSearchbar()"><i class="close icon"></i></div>
                            </div>
                    </div>
                </div>
            </form>
            <div class="ui clearing divider ">
             </div>
            
            <div class="ui stackable grid secondary-preferences">
                <div class="eight wide left floated column" >
                    <div class="ui unstackable grid">
                        <div class="thirteen wide left floated column" >

                            <div id="stock_render_mode" class="covert" tabindex="0"  >
                                <div class="ui labeled large button"  >
                                    {{if show_cart}}
                                    <div class="ui blue button" data-show_cart="0" >
                                        <i class="chevron left icon"></i> К товарам
                                    </div>
                                    {{else}}
                                    <div class="ui blue button" data-show_cart="1" >
                                        <i class="shopping cart icon"></i> Корзина
                                    </div>
                                    {{/if}}
                                    <a class="ui basic blue left pointing label" >
                                        {{ cart_quantity }} / {{ total }} ₽
                                    </a>
                                </div>
                            </div> 
                        </div> 
                        <div class="two wide right floated column" id='stock_secondary_prefs_button' style="display: none">
                            <div  class='ui  basic  icon button' onclick="$('#stock_secondary_prefs_content').toggle('fast')">
                                <i class='settings icon'></i>
                            </div>  
                        </div>

                    </div>
                </div>

                <div class="eight wide right floated right aligned column" id="stock_secondary_prefs_content" >
                    <div class='ui unstackable form'> 
                        <div class='fields'> 
                            <div class='eight wide left aligned field'>
                                <div class="ui selection labeled  dropdown order-by-dropdown" style="min-width:auto">
                                    <i class="dropdown icon"></i>
                                    <div class="default text" style='white-space: nowrap;text-overflow: ellipsis;max-width: 100%;overflow: hidden;'>
                                        Сначала популярные
                                    </div>
                                    <div class="menu">
                                        <div class="item" data-value="popularity,DESC">Сначала популярные</div>
                                        <div class="item" data-value="popularity,ASC">Сначала непопулярные</div>
                                        <div class="item" data-value="price,ASC">Сначала дешевые</div>
                                        <div class="item" data-value="price,DESC">Сначала дорогие</div>
                                        <div class="item" data-value="newness,DESC">Сначала новинки</div>
                                        <div class="item" data-value="newness,ASC">Сначала постоянные</div>
                                    </div>
                                </div>
                            </div>
                            <div class='four wide left aligned field'>
                                <div class="ui selection labeled  dropdown limit-dropdown" style="min-width:auto">
                                    <i class="dropdown icon"></i>
                                    <div class="default text">12</div>
                                    <div class="menu">
                                        <div class="item" data-value="12">12</div>
                                        <div class="item" data-value="24">24</div>
                                        <div class="item" data-value="48">48</div>
                                        <div class="item" data-value="100">100</div>
                                    </div>
                                </div>
                            </div>
                            <div class='three wide left aligned field'>
                                <div class="ui basic buttons">
                                    <button class="ui  icon button" onclick="App.stock.entries.gridViewToggle(0)"> <i class="list icon"></i></button>
                                    <button class="ui   icon button" onclick="App.stock.entries.gridViewToggle(1)"> <i class="table icon"></i></button>
                                </div>
                            </div> 
                        </div> 
                    </div>
                </div>
            </div>
        </div>


        <div id="stock_list" class="covert">
            <div class="product-list-grid" >
                    <!-- {{if products}} {{products}} -->
                <div class='product-item' id="product_item_{{#}}" style=" {{if is_promo}}  background-color: #cfc;{{/if}}{{ if product_quantity|more>0 }} background-color: #ffd; {{else }}{{/if}}">

                    <div class="product-item-grid {{if price_promo}}product-item-promo{{/if}}" >
                        <div class='product-image-column image-{{#}}' data-row-index="{{#}}" >
                            <a href="#product.html#product_id={{product_id}}">
                                <img src="../Storage/image_flush/?size=250x250&path=/dynImg/{{product_img}}" >
                            </a>
                        </div>
                        <div class="product-name-column">
                            <a href="#product.html#product_id={{product_id}}">
                                {{product_name}}
                                {{if analyse_class|equals>C}}
                                <i class="icon star"></i>
                                {{/if}}
                            </a>
                        </div>
                        <div class="product-info-column">
                            <div class="ui grid" style="color:#666; padding-right:1.4em">
                                <div class="eight wide column">
                                    {{product_code}}
                                </div>
                                <div class="four wide column product-price" style="text-align: right">
                                    {{if price_promo}}
                                        <s>{{price_basic|format}}</s>
                                    {{/if}}
                                    <b>{{price_final|format}}</b>
                                </div>
                                <div class="four wide column" style="text-align: right">
                                    {{if leftover|more>0}}
                                    <span>
                                    {{else}}
                                    <span style="color:red">
                                    {{/if}}
                                    {{leftover}}{{product_unit}}
                                    </span>
                                    <div>
                                        {{if product_reserved|more>0}}
                                        <span style="color:red">-{{product_reserved}}</span>
                                        {{/if}}
                                        {{if product_awaiting|more>0}}
                                        <span style="color:green">+{{product_awaiting}}</span>
                                        {{/if}}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="product-action-column">
                            <div class="ui centered grid">
                                <div class="twelve wide column">
                                    <div class="ui left icon input tiny fluid"  >
                                        <input type='hidden' name='product_img' value='{{product_img}}'>
                                        <input type='hidden' name='product_name' value='{{product_name}}'>
                                        <input type='hidden' name='product_code' value='{{product_code}}'>
                                        <input type='hidden' name='product_id' value='{{product_id}}'>
                                        <input type='hidden' name='leftover' value='{{leftover}}'>
                                        <input type='hidden' name='price_final' value='{{price_final}}'>

                                        <button class="ui  {{if product_quantity|less>1}} disabled   {{/if}} left attached icon  button minus-button" data-delta="-1" data-index="{{#}}">
                                            <i class="minus icon" data-delta="-1" data-index="{{#}}"></i>
                                        </button>
                                        <input type="number" name="product_quantity" placeholder="Количество" min="1" class="product_quantity"
                                                style="border-radius: 0px;   
                                                padding-left: 1em !important; 
                                                padding-right: 0.5em !important;" 
                                                data-index="{{#}}"
                                                value="{{if product_quantity|more>0}}{{product_quantity|blank>1}}{{else}}0{{/if}}">
                                        <button class="ui right attached icon  button plus-button" data-delta="1" data-index="{{#}}">
                                            <i class="plus icon" data-delta="1" data-index="{{#}}"></i>
                                        </button>

                                    </div> 
                                    <div class="ui basic  label product-total" style="display:none">{{if product_quantity|more>0}}{{product_sum}}{{else}}0{{/if}} ₽</div>
                                </div>
                                {{if product_quantity|more>0}}
                                <div class="four wide column product-clear-button-container" >
                                {{else}} 
                                <div class="four wide column product-clear-button-container" style="display:none">
                                {{/if}}
                                    <div class="ui circular icon button product-clear-button"  data-action="clear" data-index="{{#}}">
                                        <i class="trash alternate icon"  data-action="clear"  data-index="{{#}}"></i>
                                    </div>
                                </div>
                                        
                            </div>


                        </div>

                    </div>
                </div>
                <!-- {{/products}} {{else}}-->
                {{if show_cart|falsy}}
                <div>
                    <div >
                        <div class="ui info message" style="clear: both;text-align: center;">
                            Ничего не найдено. Возможно необходимо <a href="javascript:App.stock.filter.clearSelected()" style="color:red">сбросить фильтры</a> или <a href="javascript:App.stock.head.clearSearchbar()" style="color:red">изменить поисковый запрос</a>.
                        </div>  
                    </div>
                </div>
                {{/if}}
                <!--{{/if}}-->
            </div>

            {{if show_cart|falsy}}
                {{if loading_finished}} 
                <div class="ui info message" style="clear: both;text-align: center;">
                    Больше нет товаров для показа
                </div>   
                {{else}} 
                <button id='stock_load_more' class='ui fluid  button' onclick="App.stock.entries.load(1)"> 
                    Показать ещё...
                </button>    
                {{/if}} 
             {{else}} 
                {{if products|length|more>0}} 
                <a class="ui approve green labeled icon button" href="#document.html" style="float: right; margin-top: 1em;">
                    <i class="check icon"></i>
                    Заказ
                </a>
                {{else}}
                <div class="ui info message" style="clear: both;text-align: center;">
                    <i class="exclamation icon"></i>
                    Вы не добавляли товары в корзину
                </div>   
                {{/if}}
            {{/if}}
        </div>
    </div>
</div>

<div id="categoriesPopup" class="ui long modal" >
    <div class="header" style='padding: 1em;'>Выберите категорию
        <a  class="ui secondary close icon button" style="float:right" onclick="$('#categoriesPopup').modal('hide');"><i class="icon close"></i></a>
    </div>
    <div class="ui form" style="padding:1em">
        <div class="ui fields">
            <div class="three wide field">
                <label>Выбрать</label>
                <button class=" ui floated right blue fluid button" id="category_All" data-category_id="All" >
                        Все категории
                </button>
            </div>
            <div id="categories_input" class="thirteen wide field">
                <label>Поиск</label>
                <div class="ui left icon right labeled input fluid" style="margin-bottom: 5px;">
                    <i class="search icon"></i>
                    <input id="categories_search_input" placeholder="Введите название категории..." type="text" value=""
                           oninput="App.stock.categories.find(this.value)">
                    <div class="ui basic label" onclick="App.stock.categories.clearSearchbar()"><i class="close icon"></i></div>
                </div>
            </div> 
        </div>
    </div>
    <div id="categories_search_container" style="display: none; height:max-content; border-top:1px solid lightgray">
        <div class="daughter-category category-has-no-children" ><h3>Результаты поиска: </h3></div>
        {{if categories}}
        {{categories|limit>12}}
                <div class="daughter-category category-has-no-children" id="suggest_category_{{branch_id}}">
                    <label data-category_id="{{branch_id}}">{{label}}</label>
                </div>
        {{/categories}}
        {{else}}
        <div class="daughter-category category-has-no-children" >Ничего не найдено</div>
        {{/if}}
    </div>
    <div class="ui divider"></div>
    <div id="categories_container" class="categories-container">
    {{categories}}
    {{if parent_id|equals>0}}
        <div class="grandmother-category" id="category_{{branch_id}}">
            <label class='grandmother-category-label' data-category_id="{{branch_id}}">{{label}}</label>
            {{if children}}
                <div class="mothers-container ">
                    {{children}}
                    <div class="mother-category category-toggler 
                         {{if children}}
                         category-has-children" id="category_{{branch_id}}"><label data-category_id="{{branch_id}}">{{label}}</label><i class='angle down icon' data-action='expand_category'></i>
                         {{else}}
                         category-has-no-children" id="category_{{branch_id}}"><label data-category_id="{{branch_id}}">{{label}}</label>{{/if}}
                        
                        {{if children}}
                            <div class="daughters-container" id="toggle_for_{{branch_id}}" style="display: none">
                                {{children}}
                                <div class="daughter-category category-toggler {{if children}}category-has-children{{else}}category-has-no-children{{/if}}" id="category_{{branch_id}}" ><label data-category_id="{{branch_id}}">{{label}}</label></div>
                                {{/children}}
                            </div>
                        {{/if}}

                    </div>
                    {{/children}}
                </div>
            {{/if}}
        </div>
    {{/if}}
    {{/categories}}
     </div>
</div>

