<script>
    App.checkout_document = {
        current_entry_index: '',
        currentType: 'Document',
        checkout_id: "",
        input_barcode: '',
        checkout_doc_head: [],
        init: function () {
            //App.checkout_document.check_storage();
            App.checkout_document.focus();
            document.addEventListener('keypress', function (event) {
                var char=event.key;
                if(char*1==char){
                    App.checkout_document.input_barcode += event.key;
                    if (App.checkout_document.input_barcode.length == 13){
                        App.checkout_document.entries.search_barcode(App.checkout_document.input_barcode);
                        App.checkout_document.input_barcode='';
                    }    
                } else {
                    App.checkout_document.input_barcode='';
                }  
            });
            App.checkout_document.initTab();
            setTimeout(function(){
                App.checkout_document.suggestion.init();
            },500);
            if(App.checkout_document.device_has_numeric_keypad){
                $("#quan_popup_content").on('keypress',function(e){
                    var $inp=$("#checkout_document_popup_quan_form input[name=operation_quantity]");
                    if( $.isNumeric(e.key) ){
                        $inp.val($inp.val()+''+e.key);
                    } else if(e.key=='Backspace'){
                        $inp.val(  $inp.val().substring(0, $inp.val().length - 1) );
                    } else if(e.key=='-'){
                        $inp.val(-1*str);
                    }
                });
                $("#checkout_document_popup_quan_form input[name=operation_quantity]").attr('readonly',1);
            }
        },
        load: function (checkout_id){
            var def=$.Deferred();
            App.checkout_document.log.put_on_server().done(function(){
                $.post('../Checkout/checkoutDocumentGet', {checkout_id: checkout_id}, function (resp) {
                    var response = App.json(resp);
                    App.checkout_document.entries.set(response.entries);
                    App.checkout_document.log.list = response.log;
                    App.checkout_document.checkout_doc_head = response.head;
                    App.checkout_document.photos.render();
                    App.checkout_document.entries.render();
                    def.resolve();
                });
            });
            return def.promise();
        },
        focus: function () {
            App.title("Документ для проверки");
            App.checkout_document.entries.selection_mode_toggle('off');
            App.checkout_document.currentType = 'Document';
            App.checkout_document.initTab();
            App.checkout_document.load(App.state.checkout_id);
	    this.device_has_numeric_keypad=localStorage.getItem('device_has_numeric_keypad')=='true'?1:0;
            //App.checkout_document.log.put_on_server();
        },
        blur: function (){
            App.checkout_document.log.put_on_server();
            clearTimeout(App.checkout_document.sync_clock);
        },
        initTab: function () {
            $('.checkout_document_tabs .item').tab({
                onVisible: function (type) {
                    App.checkout_document.currentType = type;
                    if(type === "Document"){
                        App.checkout_document.entries.render();
                    }
                    if(type === "Log"){
                        App.checkout_document.log.render();
                    }
                    if(type === "Photos"){
                        App.checkout_document.photos.render();
                    }
                }
            });
            $('.checkout_document_tabs .item').tab('change tab', App.checkout_document.currentType);
        },
        render_head: function(){
            if (App.state.checkout_id == 0){
              var now = new Date().toLocaleString().replace(',','').substr(0,15);  
              App.checkout_document.checkout_doc_head = {
                  checkout_id: 000,
                  checkout_name: 'Новая проверка',
                  checkout_status: 'not_checked',
                  creator_nick: App.user.props.user_sign,
                  modifier_nick: App.user.props.user_sign,
                  cstamp_dmy: now
              };
            }
            setTimeout(function(){
                App.renderTpl("doc_head", App.checkout_document.checkout_doc_head);
            },0);
        },
        generate_product_log: function () {
            var fvalue = $('#checkout_document_popup_quan_form').form('get values');
            $("#checkout_document_log_search_input").val(fvalue.product_code);
            App.checkout_document.log.render();
            $('.checkout_document_tabs .item').tab('change tab', 'Log');
        },
        progress_update: function(){
            var verified = 0;
            var total = 0;
            App.checkout_document.entries.list.forEach(function(item){
                  verified += Math.min(item.product_quantity_verified, item.product_quantity);
                  total += item.product_quantity*1;
            });
            if (verified > 0){
                
            };
            $('#checkout_progress_bar').progress("set percent", verified/total*100 );
        },
        clear_searchbar: function () {
            $("#checkout_document_log_search_input").val('');
            App.checkout_document.log.render();
        },
        check_storage: function () {
            var storage_log_list = App.json(App.restore('log_list'));
            if (storage_log_list != null) {
                App.checkout_document.log.list = storage_log_list;
            } else {
                return true;
            }
        },
        finish:{
            init:function(){
                App.checkout_document.finish.warning_entries = [];
                App.checkout_document.blur();
                for( let item of App.checkout_document.entries.list){
                    var difference = item.product_quantity_verified - item.product_quantity;
                    if(difference!=0){
                        item.difference=difference;
                        item.color="red";
                        if( difference>0 ){
                            item.difference="+"+difference;
                            item.color="green";
                        }
                        
                        App.checkout_document.finish.modal.warning_entries.push(item);
                    }
                }
                if( App.checkout_document.finish.modal.warning_entries.length>0){
                    App.renderTpl('checkout_confirm_warning_list', {products: App.checkout_document.finish.modal.warning_entries});
                    App.checkout_document.finish.modal.open();
                } else {
                    App.checkout_document.finish.commit();
                }
            },
            commit:function(){
                App.checkout_document.finish.modal.close();
                if(App.checkout_document.checkout_doc_head.parent_doc_id>0){
                    $.post('../Checkout/checkoutDocumentOutput', {checkout_id: App.state.checkout_id}, function (resp) {
                        var result=App.json(resp);
                        if( result ){
                            App.checkout_document.finish.show_result(result);
                            App.holder.load("checkout_document_list.html");
                        }
                    });
                } else {
                    App.user.pcompSelect({company_id:App.user.acomp.company_id}).done(function(){
                        $.post('../Checkout/checkoutDocumentOutput', {checkout_id: App.state.checkout_id}, function (resp) {
                            App.alert("Созданы корректировочные накладные в <b>"+App.user.pcomp.label);
                            App.holder.load("checkout_document_list.html");
                        });
                    });
                }
            },
            show_result:function(result){
                var msg='';
                if( result.less>0 ){
                    msg+=`Недостача: ${result.less} позиций<br>`;
                }
                if( result.more>0 ){
                    msg+=`Избыток: ${result.more} позиций<br>`;
                }
                if( result.added>0 ){
                    msg+=`Добавлено строк: ${result.added}<br>`;
                }
                if( result.deleted>0 ){
                    msg+=`Удалено строк: ${result.deleted}<br>`;
                }
                if( result.updated>0 ){
                    msg+=`Изменено строк: ${result.updated}<br>`;
                }
                App.alert("Результат проверки:<br>"+msg);
            },
            modal:{
                warning_entries:[],
                open: function(){
                    $('#checkout_confirm_warning').modal('show').modal('can fit');
                },
                close:function(){
                    $('#checkout_confirm_warning').modal('hide');
                }
            }
        },
        entries: { 
            list: [],
            temp_barcode: '',
            selection_mode: 'off',
            popup_mode: 'off',
            sort:function(){
                App.checkout_document.entries.list.sort(function(a,b){
                    if( a.match && b.match || !a.match && !b.match ){
                        return a.product_code>b.product_code?1:-1;
                    }
                    if( a.match ){
                        return -1;
                    }
                    return 1;
                });
            },
            add:function( entry ){
                App.checkout_document.entries.list.push(entry);
                App.checkout_document.entries.sort();
            },
            set:function( entries ){
                App.checkout_document.entries.list = entries;
                App.checkout_document.entries.sort();
            },
            select:function( code_or_barcode ){
                let index=-1;
                for( let i in App.checkout_document.entries.list ){
                    let entry=App.checkout_document.entries.list[i];
                    if( entry.product_code == code_or_barcode || entry.product_barcode == code_or_barcode ){
                        index=i;
                    }
                }
                App.checkout_document.current_entry_index = index;
                return index;
            },
            filter:function(){
                var search_query=$('#checkout_document_entries_search_input').val().replace(' ', '|') || '';
                for( let i in App.checkout_document.entries.list ){
                    let entry=App.checkout_document.entries.list[i];
                    let pattern = new RegExp(search_query, 'i');
                    let product_data = entry.ru + ' ' + entry.product_code + ' ' + entry.product_barcode;
                    if( search_query && pattern.test(product_data) ){
                        App.checkout_document.entries.list[i].match=1;
                    } else {
                        App.checkout_document.entries.list[i].match=0;
                    }
                }
                this.sort();
                this.render();
            },
            render: function () {
                if( App.checkout_document.currentType!=="Document" ){
                    return;
                }
                setTimeout(function(){
                    if(App.checkout_document.entries.popup_mode !== 'on'){
                        App.checkout_document.current_entry_index = '';
                    }
                    App.checkout_document.input_barcode = '';
                    $("#checkout_document_log_search_input").val('');
                    App.checkout_document.progress_update();
                    App.checkout_document.render_head();
                    App.checkout_document.entries.popup_mode='off';
                    App.renderTpl("checkout_entries", {products: App.checkout_document.entries.list});
                },0);
            },
            update:function(operation_quantity){
                var currentEntry=App.checkout_document.entries.list[App.checkout_document.current_entry_index];
                var product_verified = currentEntry.product_quantity_verified*1 + operation_quantity*1;
                var product_quantity = currentEntry.product_quantity * 1;
                if (product_verified < 0){
                    App.flash("Орицательное количество!");
                    return true;
                }
                if (product_verified === product_quantity) {
                    currentEntry.verification_status = 1;
                }else if (product_verified > product_quantity || product_verified < product_quantity  ) {
                    currentEntry.verification_status = 2;
                };
                currentEntry.product_quantity_verified = product_verified;
                App.checkout_document.log.write_to_log(operation_quantity, currentEntry);
                App.speech.say(operation_quantity+currentEntry.product_unit);
            },
            search_barcode:function ( code_or_barcode ){
                let found_entry_index=App.checkout_document.entries.select( code_or_barcode );
                if ( found_entry_index>-1 ){
                    /*if( $('#checkout_document_quantity_popup').css('display')==='none' ){
                    }*/
                    if( App.checkout_document.entries.popup_mode === 'on'){
                        App.checkout_document.entries.update(1);
                        App.checkout_document.entries.show_popup();
                        return;
                    }
                    App.checkout_document.entries.show_popup();
                } else {
                    $('#checkout_document_quantity_popup').modal('hide');
                    App.checkout_document.entries.render();
                    App.checkout_document.entries.load_by_barcode( code_or_barcode );
                }
            },
            load_by_barcode: function (barcode) {
                App.flash('Поиск товара по штрихкоду');
                $.post('../Checkout/checkoutProductGet', {barcode: barcode,checkout_id:App.state.checkout_id}, function (resp) {
		    var new_entry = App.json(resp);
                    if ( new_entry ){
                        if( App.checkout_document.checkout_doc_head.parent_doc_id ){
                            new_entry.product_quantity = '0';
                        }
                        new_entry.checkout_id = App.state.checkout_id;
                        new_entry.product_quantity_verified = '0';
                        new_entry.verification_status = '0';
                        App.checkout_document.entries.add(new_entry);
                        App.checkout_document.entries.select( new_entry.product_code );
                        App.checkout_document.entries.show_popup();
                        App.checkout_document.entries.selection_mode_toggle('off');
                        App.checkout_document.input_barcode='';
                        App.flash('Товар найден и добавлен');
                     } else {
                        App.confirm('Штрихкод не найден! Выберите из списка').done(function(){
                            App.checkout_document.entries.temp_barcode = barcode;
                            App.checkout_document.entries.selection_mode_toggle('on');
                            App.checkout_document.entries.render();
                        });
                    }
		});
            },
            search_by_prod_code: function(){
                App.checkout_document.entries.selection_mode_toggle('off');
                App.prompt('Введите код товара. Для штрихкода: '+App.checkout_document.entries.temp_barcode).done(function(product_code){
                    if (product_code){
                        App.checkout_document.entries.link_barcode(product_code,App.checkout_document.entries.temp_barcode);
                    }
                });
            },
            selection_mode_toggle( mode ){
                App.checkout_document.entries.selection_mode = mode;
                if( mode === 'on'){
                    $('#doc_head').hide();
                    $('#checkout_photo_upload').hide();
                    $('#checkout_suggestion_mother').hide();
                    $('#checkout_document_head').hide();
                    $('#photos_tab_header').hide();
                    $('#checkout_selection_mode_button').show();
                } else if( mode === 'off' ){
                    $('#doc_head').show();
                    $('#checkout_photo_upload').show();
                    $('#checkout_suggestion_mother').show();
                    $('#checkout_document_head').show();
                    $('#photos_tab_header').show();    
                    $('#checkout_selection_mode_button').hide();
                }
            },
            link_barcode: function(product_code, barcode){
              var fvalue={
		    product_code: product_code,
		    field:'product_barcode',
		    value: barcode
		};
		$.post("../Stock/productUpdate/",fvalue,function(ok){
		    if(ok){
			App.flash("Штрихкод привязан");
                        App.checkout_document.entries.selection_mode_toggle('off');
                        App.checkout_document.load(App.state.checkout_id).done(function(){
                            App.checkout_document.entries.search_barcode(barcode);
                        });
		    } else {
                        App.flash("Не удалось");
                    }
		});  
            },
            submit_form: function ( mode ) {
                var fvalue = $('#checkout_document_popup_quan_form').form('get values');
                if(fvalue.operation_quantity == 0){
                    $("#popup_quantity_message").show('fast');
                    return false;
                } else {
                    $("#popup_quantity_message").hide();
                }
                if( mode=='minus_quantity' ){
                    fvalue.operation_quantity*=-1;
                }
                $('#checkout_document_quantity_popup').modal('hide');
                App.checkout_document.entries.update(fvalue.operation_quantity);
                App.checkout_document.entries.render();
            },
            show_popup_by_click: function (node) {
                App.checkout_document.current_entry_index = $(node).data('index');
                if( App.checkout_document.entries.selection_mode === 'on' ){
                    var product_code = App.checkout_document.entries.list[App.checkout_document.current_entry_index].product_code;
                    App.checkout_document.entries.link_barcode(product_code, App.checkout_document.entries.temp_barcode);
                    return;
                }
                this.show_popup();
            },
            show_popup: function () {
                App.checkout_document.entries.popup_mode='on';
                var popup_product_data=App.checkout_document.entries.list[App.checkout_document.current_entry_index];
                popup_product_data.product_quantity_left=popup_product_data.product_quantity-popup_product_data.product_quantity_verified;
                if( popup_product_data.product_spack!==popup_product_data.product_bpack && popup_product_data.product_bpack>1){
                    popup_product_data.product_bpack_isunique=1;
                }
                App.renderTpl("quan_popup_content", {products:popup_product_data});
                $("#popup_quantity_message").hide();
                $('#checkout_document_quantity_popup').modal({
		    duration:0
		}).modal('show');
                var spell=(popup_product_data.spell || popup_product_data.ru).split(" ").splice(0,6).join(" ");//limiting name to 6 words
                App.speech.say(spell);
            },
            popup_quantity_backspace_emulate:function(){
                var str=$("#checkout_document_popup_quan_form input[name=operation_quantity]").val();
                $("#checkout_document_popup_quan_form input[name=operation_quantity]").val(  str.substring(0, str.length - 1) );
            },
            check_package_type: function (type) {
                var currentEntry=App.checkout_document.entries.list[App.checkout_document.current_entry_index];
                var quantity=1;
                if (type === 'Extra_Small') {
                    quantity=1;
                } else if (type === 'Small') {
                    quantity=currentEntry.product_spack;
                } else if (type === 'Big') {
                    quantity=currentEntry.product_bpack;
                }   else if (type === 'qty') {
                    quantity=currentEntry.product_quantity_left;
                }
                $("#checkout_document_popup_quan_form input[name=operation_quantity]").val(quantity);
                App.checkout_document.entries.submit_form();
            }
        },
        log: {
            list: [],
            put_on_server: function (){
                var deffered = $.Deferred();
                clearTimeout(App.checkout_document.sync_clock);
                var uncommited_logs = [];
                if(App.checkout_document.log.list){
                    for (var item in App.checkout_document.log.list){
                        if(App.checkout_document.log.list[item].is_commited === false){
                            App.checkout_document.log.list[item].index = item;
                            uncommited_logs.push(App.checkout_document.log.list[item]);
                        }
                    }
                    if( uncommited_logs.length < 1 ){
                        deffered.resolve();
                    } else {
                        var uncommited_logs_json = JSON.stringify( uncommited_logs );    
                        $.post('../Checkout/checkoutLogCommit', { checkout_id: App.state.checkout_id, entries: uncommited_logs_json }, function (okey) {
                            if(okey*1){
                                App.checkout_document.log.make_commited(uncommited_logs);
                                deffered.resolve();
                            } 
                        });    
                    }    
                } else {
                    deffered.resolve();
                }
                App.checkout_document.sync_clock=setTimeout(App.checkout_document.log.put_on_server, 10000); 
                return deffered.promise();
            },
            make_commited: function(uncommited_logs){
                for(var i in uncommited_logs){
                    for (var k in App.checkout_document.log.list){
                        if(uncommited_logs[i].index == k){
                            App.checkout_document.log.list[k].is_commited = true;
                        }
                    }
                }
                App.store('log_list', App.checkout_document.log.list);
            },
            write_to_log: function (operation_quantity, product_info) {
                App.checkout_document.checkout_doc_head.checkout_status = 'is_checking';
                var now = new Date();
                var time = now.toISOString().substr(0,10) + ' ' + now.toLocaleTimeString();
                var product_to_write ={
                            product_id: product_info.product_id,
                            ru: product_info.ru,
                            product_code: product_info.product_code,
                            operation_quantity: operation_quantity,
                            product_unit: product_info.product_unit,
                            verification_status: product_info.verification_status,
                            cstamp: time,
                            is_commited: false
                        };
                App.checkout_document.log.list.push(product_to_write);
                App.store('log_list', App.checkout_document.log.list);
                App.checkout_document.log.put_on_server();
            },
            rewrite_to_log: function (node) {
                var product_quantity = $(node).data('operation_quantity') * -1;
                var product_info = $(node).data();
                for (var i = 0; i < App.checkout_document.entries.list.length; i++) {
                    var item=App.checkout_document.entries.list[i];
                    if (item.product_code == product_info.product_code) {
                        App.checkout_document.current_entry_index = i;
                        App.checkout_document.entries.update(product_quantity);
                        break;
                    }
                }
                App.checkout_document.entries.render();
                App.checkout_document.log.render();
            },
            filter: function () {
                var now = new Date();
                var today = now.toISOString().substr(0,10);
                var yesterday = new Date(now.setDate(now.getDate() - 1)).toISOString().substr(0,10);
                var search_query = $("#checkout_document_log_search_input").val();
                search_query = search_query.replace(' ', '|');
                var product_log = [];
                for (var i = 0; i < App.checkout_document.log.list.length; i++) {
                    var item = App.checkout_document.log.list[i];
                    var pattern = new RegExp(search_query, 'i');
                    var product_data = item.ru + ' ' + item.product_code + ' ' + item.product_barcode;
                    if ( pattern.test(product_data) ) {
                        item.time_to_display = item.cstamp.replace(today, "Сегодня в ").replace(yesterday, "Вчера в ");
                        product_log.push(item);
                        $('#no_match_message').hide();
                    }
                }
                return product_log.reverse();
            },
            renderClock:null,
            render: function () {
                if( App.checkout_document.currentType!=="Log" ){
                    return;
                }
                var product_log = App.checkout_document.log.filter();
                $('.checkout_document_tabs .item').tab('change tab', 'Log');
                clearTimeout(App.checkout_document.log.renderClock);
                App.checkout_document.log.renderClock=setTimeout(function(){
                    App.checkout_document.render_head();
                    App.renderTpl("log_list", {log_list: product_log});
                },100);
            },
            handleClick: function (row_node) {
                var product_code = $(row_node).data('product_code');
                App.checkout_document.entries.select( product_code );
                App.checkout_document.entries.show_popup();
	    }
        },
        photos:{
            list: [],
            render: function (){
                if( App.checkout_document.currentType!=="Photos" ){
                    return;
                }
                App.checkout_document.photos.list = App.checkout_document.checkout_doc_head.checkout_photos?App.checkout_document.checkout_doc_head.checkout_photos.split(",").reverse():[];
                var photos=[];
                for(var filename of App.checkout_document.photos.list){
                    if( !filename ){
                        continue;
                    }
                    var photo_date=new Date (parseInt(filename));
                    var photo={
                        filename:filename,
                        date:photo_date.toLocaleDateString()+" "+photo_date.toLocaleTimeString()
                    };
                    photos.push(photo);
                }
                App.renderTpl("checkout_photos_tab", {checkout_photos: photos});
            },
            up:function(fileList){
                if( fileList.length ){
                    if( fileList[0].type.indexOf('image')===-1 ){
			alert("Файл должен быть изображением");
			return false;
		    }
                    var file_name=(new Date()).getTime()+'.'+fileList[0].name.split('.').pop();
                    var url = '../Checkout/checkoutUp/';
                    var xhr = new XMLHttpRequest();
                    var fd = new FormData();
                    xhr.open("POST", url, true);
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState === 4 && xhr.status === 200) {
                            if( xhr.responseText.indexOf('uploaded')>-1 ){
                                App.flash("Фото загружено");
                                App.checkout_document.load(App.state.checkout_id);
                            } else {
                                App.flash("Не удалось загрузить");
                            }
                        }
                    };
                    fd.append("checkout_id",App.state.checkout_id);
                    fd.append("file_name",file_name);
                    fd.append("upload_file", fileList[0]);
                    xhr.send(fd);
                }
            },
            checkout_upload:function(){
                $('#checkout_attach').click();
            }
        },
        suggestion: {
	    q: '',
	    entries: [],
	    init: function () {
		$("#checkout_suggestion").accordion({
		    onOpen: function () {
			App.checkout_document.suggestion.search("");
		    }
		});
		$("#checkout_suggestion input").on('keyup', function () {
		    App.checkout_document.suggestion.search($("#checkout_suggestion input").val());
		});
	    },
	    search: function (q) {
		clearTimeout(this.clock);
		this.clock = setTimeout(function () {
		    App.checkout_document.suggestion.q = q;
		    App.checkout_document.suggestion.entries = [];
		    App.checkout_document.suggestion.load();
		}, 200);
	    },
	    load: function () {
		App.flash('Подсказки: загрузка...');
		var offset = App.checkout_document.suggestion.entries.length || 0;
		$.post('../DocumentItems/suggestFetch', {offset: offset, q: App.checkout_document.suggestion.q}, function (resp) {
		    var suggestion = App.json(resp);
		    App.checkout_document.suggestion.entries = App.checkout_document.suggestion.entries.concat(suggestion);
		    App.checkout_document.suggestion.render();
		    if (suggestion && suggestion.length > 0) {
			$("#checkout_load_suggestions_button").show();
		    } else {
			$("#checkout_load_suggestions_button").hide();
		    }
		    App.flash('Подсказки: ОК');
		});
	    },
	    clear:function(){
		$("#checkout_suggestion input").val('');
		App.checkout_document.suggestion.search('');
	    },
	    render: function () {
		App.renderTpl('checkout_doc_suggestion_entries', {entries: App.checkout_document.suggestion.entries});
	    },
	    handleClick: function (row_node) {
		var index = $(row_node).data('row-index');
		var suggest_entry = App.checkout_document.suggestion.entries[index];
		App.checkout_document.entries.search_barcode(suggest_entry.product_code);
                //$('#checkout_suggestion').accordion('close', 0);
	    },
	    popImage: function (row_node) {
		var index = $(row_node).data('row-index');
		var suggest_entry = App.checkout_document.suggestion.entries[index];
		suggest_entry.size_x = Math.min($(checkout_document).width(), 500);
		suggest_entry.size_y = Math.min($(checkout_document).height(), 500);
		App.renderTpl('document_product_image', suggest_entry);
		$("#document_product_image").modal('show');
	    }
	}
    };
</script>    




<style>
    #checkout_document_save_button {
        position: fixed;
        bottom: 15px;
        right: 10px;
        z-index: 2;
        padding: 1.5em;
        box-shadow: 0px 0px 10px 5px rgba(0,0,0,0.25);
    }
    #doc_list .checkout_document_modified_by_tr td{
        border-top: none;
        line-height: 0.5em;
        font-size: 12px;
    }
    #checkout_document_table .product_row .three wide column{
        height: 1em;
        overflow: hidden;
    }
    div table .product_row .product_name {
        max-height: 7.3em !important;
        overflow: hidden !important;
    }
    div table .product_row .product_name div .three.wide.column{
        padding-top: 10px !important;
        padding-bottom: 0px !important;
    }
    .ui.celled.unstackable.selectable.table{
        border-top: none;
    }
    .checkout_document_product_name{
        height: 4em;
        overflow-y: hidden;
    }
    #log_list .checkout_document_log_time_td{
        border-top: none;      
    }
    #log_list .checkout_document_log_time_button_td{
        border-top: none;      
    }
    #checkout_progress_bar_container{ 
       position: fixed;
       top: 41px;
       width: 100%;
       z-index: 500;
    }
    #checkout_progress_bar{
        height: 0.2em;
        border-radius: 0px !important;
    }  
    #checkout_progress_bar .bar{
        height: 0.2em;
        border-radius: 0px !important;
    }
</style>

<div id="checkout_progress_bar_container" >
    <div id="checkout_progress_bar" class="ui indicating blue progress" data-value="0">
      <div class="bar"></div>
    </div>
</div>

<div id="doc_head" class="ui segment covert">
    <div class="ui segments">
    <div id="chdocument_header" class="ui segment ">
	<div class="ui header">
            <i class="large clipboard list icon"></i> Список проверки
	</div>
	 "{{checkout_name}}" от {{cstamp_dmy}}
        {{if parent_doc_id|more>0}}
            <a href="#document.html#doc_id={{parent_doc_id}}">
                <br><i class="file alternate outline icon"></i> открыть накладную
            </a>
        {{/if}}
    </div>
    <div class="ui  segment">
	{{if checkout_status|equals>not_checked}}
	<i class="close red large icon"></i>
	    Не выполнено
	{{else}}
	    {{if checkout_status|equals>checked}}
	    <i class="check green large icon"></i>
		Выполнено
	    {{else}}
		{{if checkout_status|equals>checked_with_divergence}}
		<div>
		    <i class="large icons">
			<i class="check green icon"></i>
			<i class="top right corner minus red icon"></i>
			<i class="bottom right corner plus green icon"></i>
		    </i>
			Выполнено (с расхождениями)
		</div>
		{{else}}
		    {{if checkout_status|equals>is_checking}}
			<i class="spinner blue loading large icon"></i>
			    Выполняется
		    {{/if}}
		{{/if}}
	    {{/if}}
	{{/if}}
        <div class="ui bottom right attached label">
            <i class=" plus circle icon"></i>
            <i>{{creator_nick}}</i>
        </div>
        <div class="ui top right attached  label">
            <i class=" pencil alternate icon"></i>
            <i>{{modifier_nick}}</i>
        </div>
    </div>
    </div>
    <div class="ui center aligned grid">
        <div class="ui equal width row">
            <div class="column">
                {{if checkout_status|equals>is_checking}}
                <button class="ui fluid primary button" onclick="App.checkout_document.finish.init();" type="button">
                    <i class="ui check icon"></i> Завершить проверку
                </button>
                {{/if}}
            </div>
            <div class="column">
                <button class="ui fluid button" onclick="App.checkout_document.photos.checkout_upload()">
                    <i class="ui photo icon"></i> Прикрепить фото
                </button>
            </div>
        </div>    
    </div>
</div>


<input id="checkout_attach" style="display:none"  type="file" onchange="App.checkout_document.photos.up(this.files)"/>

<div id="checkout_document_head"  class="ui top attached tabular menu checkout_document_tabs ">
    <a id="document_tab_header" class="active item" data-tab="Document">Документ</a>
    <a id="log_tab_header" class="item" data-tab="Log">Операции</a>
    <a id="photos_tab_header" class="item" data-tab="Photos">Фото</a>
</div>

<button class="ui fluid negative button" id="checkout_selection_mode_button" onclick="App.checkout_document.entries.search_by_prod_code()">
    <i class="close icon"></i> В списке нет нужного товара
</button> 

<div class="ui attached tab" style="background-color:#fff" data-tab="Document">
    <div class="ui field">
        <h4 class="ui header">Фильтр по списку</h4>
        <div class="ui left icon right labeled input fluid" style="margin-bottom: 5px;">
            <i class="search icon"></i>
            <input id="checkout_document_entries_search_input" placeholder="Введите название или код..." type="text" 
                   oninput="App.checkout_document.entries.filter();return false;">
            <div class="ui basic label" onclick="$('#checkout_document_entries_search_input').val('');App.checkout_document.entries.filter()"><i class="close icon"></i></div>
        </div>
    </div>
    <div id="checkout_entries"  class="covert">
        {{if products}}
    <table id="checkout_document_table" class="ui unstackable selectable table">
        <thead> 
            <tr>
                <th>
                    Код/Название
                </th>  
                <th class="right-aligned"> 
                    Проверено
                </th>  
            </tr>
        </thead>
        <tbody>
            <!--{{products}}-->
            <tr class="product_row" data-index="{{#}}" onclick="App.checkout_document.entries.show_popup_by_click(this)" style="{{if match}}background-color:#ff9{{/if}}">
                <td class="product_name">
                    <b>{{product_code}}</b> {{ru}}
                </td>
                <td>
                    <div style="font-size:16px; font-weight: bold; text-align: right">
                        {{if verification_status|equals>0}}
                        <span style="color:red">
                        {{else}}
                        {{if verification_status|equals>2}}
                        <span style="color:orange">
                        {{else}}
                        {{if verification_status|equals>1}}
                        <span style="color:green">
                        {{/if}}
                        {{/if}}
                        {{product_quantity_verified}} /{{product_quantity}}</span>
                    </div>
                </td>
            </tr>
            <!--{{/products}}-->
        </tbody>
    </table>
        {{else}}
        <div class="ui warning message">Список пока пуст</div>
        {{/if}}
    </div>
    
 <div class="ui inverted segment blue" id="checkout_suggestion_mother">
	<div class="ui inverted fluid accordion" id="checkout_suggestion"> 
	    <div class="title"><i class="add icon"></i>Добавить товар</div>
	    <div class="content ">
		<div class="ui left icon right labeled input fluid" style="margin-bottom: 5px;">
		    <i class="search icon"></i>
		    <input placeholder="Поиск по коду или названию" type="text">
		    <div class="ui basic label" onclick="App.checkout_document.suggestion.clear()"><i class="close icon"></i></div>
		</div>
		<div class="covert" id="checkout_doc_suggestion_entries">
		    <table class="ui very compact table unstackable">
			<tbody>
			    <!-- {{if entries}} {{entries}} -->
			    <tr>
				<td  style="height:50px" data-row-index="{{#}}" onclick="App.checkout_document.suggestion.popImage(this)">
				    <img style="width:50px" src="../Storage/image_flush/?size=50x50&path=/dynImg/{{product_img}}">
				</td>
				<td data-row-index="{{#}}" onclick="App.checkout_document.suggestion.handleClick(this)">
				    <div class="ui grid stackable" style="{{if leftover|less>1}} color:red !important {{/if}}">
					<div class="eight wide column" style="padding: .5rem !important">{{product_name}}</div>
					<div class="eight wide column" style="padding: .5rem !important">
					    <div class="ui grid" style="opacity:0.7">
						<div class="six wide column">{{product_code}}</div>
						<div class="five wide column right aligned">{{product_price_total}}р</div>
						<div class="five wide column right aligned">{{if stared_leftover}} {{stared_leftover}} {{else}} {{leftover}}{{product_unit}} {{/if}}</div>
					    </div>
					</div>
				    </div>
				</td>
			    </tr>
			    <!-- {{/entries}} {{else}}-->
			    <tr>
				<td colspan="2">Ничего не найдено</td>
			    </tr>
			    <!--{{/if}}-->
			</tbody>
		    </table>
		    <button class="ui button fluid" id="checkout_load_suggestions_button" onclick="App.checkout_document.suggestion.load();">Показать еще ...</button>
		</div>
	    </div>
	</div>
    </div>
</div>


<div id="checkout_log_tab" class="ui attached tab" style="background-color:#fff" data-tab="Log">
    <div id="checkout_document_log_search" class="ui field">
        <div class="ui field">
            <h4 class="ui header">Фильтр по операциям</h4>
            <div class="ui left icon right labeled input fluid" style="margin-bottom: 5px;">
                <i class="search icon"></i>
                <input id="checkout_document_log_search_input" placeholder="Введите название или код..." type="text" 
                       oninput="App.checkout_document.log.render()">
                <div class="ui basic label" onclick="App.checkout_document.clear_searchbar()"><i class="close icon"></i></div>
            </div>
        </div>
    </div>
    <div id='no_match_message' class='ui red floating message' style='display:none'>
        <p>По вашему запросу не найдено ни одной проверки</p>
    </div>
    <div id="log_list"  class='covert'>
        {{if log_list}}
        <table class="ui unstackable compact selectable table" >
            <thead>
                <tr>
                    <th>
                        Код/Название
                    </th>  
                    <th>
                    </th>  
                </tr>
            </thead>
            <tbody>
                <!--{{log_list}}-->
                <tr class="log_list_row" style="border: 1px">
                    <td class="log_name">
                        <div class="ui two column unstackable grid">
                            <div class="sixteen wide column"><b>{{product_code}}</b> {{ru}}</div>
                        </div>
                    </td>
                    <td class="center-aligned">                      
                        <div><b>{{operation_quantity}}</b> {{product_unit}}</div>
                    </td>
                </tr>
                <tr>
                    <td class="checkout_document_log_time_td">
                            <button class="ui blue icon button" 
                                data-product_id = "{{product_id}}"
                                data-product_code = "{{product_code}}" 
                                data-ru = "{{ru}}"
                                data-operation_quantity = "{{operation_quantity}}"
                                data-product_unit = "{{product_unit}}" 
                                data-time = "{{cstamp}}"
                                onclick="App.checkout_document.log.handleClick(this)">
                                <i class="plus icon"></i>
                            </button>
                            <i>{{time_to_display}}</i>
                    </td>
                    <td class="checkout_document_log_time_button_td">
                        <button class="ui red icon button" 
                                data-product_id = "{{product_id}}"
                                data-product_code = "{{product_code}}" 
                                data-ru = "{{ru}}"
                                data-operation_quantity = "{{operation_quantity}}"
                                data-product_unit = "{{product_unit}}" 
                                data-time = "{{cstamp}}"
                                onclick="App.checkout_document.log.rewrite_to_log(this); return false">
                            <i class="ban icon"></i>
                        </button>
                    </td>
                </tr>
                <!--{{/log_list}}-->
            </tbody>
        </table>
        
        
        {{else}}
        <div class="ui warning message">Список пока пуст</div>
        {{/if}}
    </div>
</div>

<div id="checkout_photos_tab" class="ui bottom attached tab covert" data-tab="Photos">
    <div class="ui segment">
    {{if checkout_photos}}
        <div class="ui stackable cards">
        <!--{{checkout_photos}}--> 
            <div class="ui card">
                <div class="image" style="min-height:200px;text-align: center">
                    <a href="../Storage/image_flush/?size=1000x1000&path=/checkout/{{filename}}" target="_blank">
                    <img src="../Storage/image_flush/?size=200x200&path=/checkout/{{filename}}" >
                    </a>
                </div>
              <div class="content">
                <a class="header">{{date}}</a>
              </div>
            </div>
        <!--{{/checkout_photos}}-->  
        </div>
    {{else}}
    <div class="ui warning message">Фотографии не добавлены</div>
    {{/if}}
    </div>
</div>

<div id="checkout_document_quantity_popup" class="ui tiny modal">

    <div id="quan_popup_content"  tabindex="0">
        <!--{{products}}-->
        <table class="ui celled unstackable table">
            <tbody>
                <tr>
                    <td class="left-aligned"> 
                        <div class="ui unstackable two column grid">
                            <div class="five wide column">
                                <img src="../Storage/image_flush/?size=80x80&path=/dynImg/{{product_img}}" >
                            </div>
                            <div class="eleven wide column"><b>{{product_code}}</b> {{ru}}</div> 
                        </div>
                    </td>
                </tr>
                <tr>
                    <td class='left_aligned'>
                        Проверено: {{product_quantity_verified}} из {{product_quantity}}
                    </td>
                </tr>
                <tr>
                    <td>
                        <div class="ui small header">
                            Упаковка({{product_unit}}):
                        </div>
                        <div class="actions" id="checkout_document_quantity_buttons">
                            <div class="ui equal width  grid ">
                                <div class="column">
                                    <button class="ui blue fluid button"  onclick="App.checkout_document.entries.check_package_type('Extra_Small'); return false">
                                        1 
                                    </button>   
                                </div>
                                {{if product_spack|more>1}}
                                <div class="column">
                                    <button class="ui blue fluid button"  onclick="App.checkout_document.entries.check_package_type('Small'); return false">
                                        {{product_spack}} 
                                    </button>   
                                </div>
                                {{/if}}
                                {{if product_bpack_isunique|more>0}}
                                <div class="column">
                                    <button class="ui blue fluid button"  onclick="App.checkout_document.entries.check_package_type('Big'); return false">
                                        {{product_bpack}}
                                    </button>
                                </div>
                                {{/if}}
                                {{if product_quantity_left|more>1}}
                                <div class="column">
                                    <button class="ui green fluid button"  onclick="App.checkout_document.entries.check_package_type('qty'); return false">
                                        {{product_quantity_left}} 
                                    </button>   
                                </div>
                                {{/if}}
                            </div>
                        </div>
                    </td>    
                </tr>
            </tbody>    
        </table>
         <div id="popup_quantity_message" class=" ui warning message">
             <i class="exclamation icon"></i>
                Пожалуйста, укажите количество 
         </div>
        <form id='checkout_document_popup_quan_form' class="ui form segment">
            <div class="field">
                <label>Количество</label>
                <input type='hidden' name='ru' value='{{ru}}'>
                <input type='hidden' name='product_code' value='{{product_code}}'>
                <input type='hidden' name='product_quantity' value='{{product_quantity}}'>
                <div class="ui left icon right labeled input">
                    <i class="search icon"></i>
                    <input type="number" name="operation_quantity" placeholder="Количество"
                           value="">
                    <div class="ui basic label" onclick="App.checkout_document.entries.popup_quantity_backspace_emulate()"><img src="../img/backspace-arrow.png"></div>
                </div>
            </div>
           
            <div class="actions">
                <div class="ui center aligned grid">
                    <div class="ui equal width row">
                        <div class="column">
                            <button type="submit" class="ui green submit icon fluid button" onclick="App.checkout_document.entries.submit_form(); return false">
                                <i class="plus ul icon"></i>
                                Добавить
                            </button>
                        </div>
                        <div class="column">
                            <button class="ui yellow submit icon button" onclick="App.checkout_document.entries.submit_form('minus_quantity'); return false">
                                <i class="minus ul icon"></i>
                                Отнять
                            </button>
                        </div>
                        <div class="column">
                            <button class="ui cancel icon button" onclick="App.checkout_document.entries.render();return false">
                                <i class="close ul icon"></i>
                                Отмена
                            </button>
                        </div>
                    </div>    
                </div>
                {{if product_quantity_verified|more>0}}    
                <div class="ui center aligned grid">
                    <div class="ui equal width row">
                        <button class="ui labeled icon approve button" onclick="App.checkout_document.generate_product_log(); return false">
                            <i class="list ul icon"></i>
                            История операций
                        </button>
                    </div>
                </div>    
                {{/if}}
            </div>
            <!--{{/products}}-->
        </form>
    </div>
</div>

<div class="ui special modal" id="checkout_confirm_warning">
    <div class="header">Следующие позиции не сходятся по количеству. Продолжить?</div>
    <div id="checkout_confirm_warning_list">
        <table class="ui celled unstackable table">
            <thead>
                <tr>
                    <th>Позиция</th>
                    <th>Коррек.</th>
                </tr>
            </thead>
            <tbody>
                <!--{{products}}-->
                <tr>
                    <td><b>{{product_code}}</b> {{ru}}</td>
                    <td><b style="color:{{color}}">{{difference}}</b></td>
                </tr>
                <!--{{/products}}-->
            </tbody>
        </table>
    </div>
    <div class="actions">
        <div class="ui center aligned grid">
            <div class="ui equal width row">
                <div class="column">
                    <button type="submit" class="ui green submit icon fluid button" onclick="App.checkout_document.finish.commit(); return false">
                        Корректировать
                    </button>
                </div>
                <div class="column">
                    <button class="ui cancel icon fluid button" onclick="App.checkout_document.entries.render();
                            return false">
                        Отмена
                    </button>
                </div>
            </div>    
        </div>
    </div>
</div>
