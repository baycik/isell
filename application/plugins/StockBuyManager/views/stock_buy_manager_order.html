<script>
    (function ($) {
        function init() {
	    Layout.init();
	    Order.init();
	    Summary.init();
        }

	var Layout={
	    init:function(){
		Layout.adjustHolders();
		setTimeout(function(){
		    Layout.adjustHolders();
		},1000);
	    },
	    adjustHolders:function(){
		//Layout.calcDimensions("#supply_order_sg");
	    },
	    calcDimensions:function(query, dw, dh){
		var wheight = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
		var height = (wheight - $(query).position().top - 20 + (dh || 0)) + 'px';// - $(query).position().top - 0
		var width = $(query).parent().width() + (dw || 0);
		$(query).css('min-height', height);
		$(query).css('width', width);
	    },
	    Accordion:function(query){
		var container = $(query);
		var observer = {
		    onselect: function () {}
		};
		function collapse(mode) {
		    container.find(".accordion").each(function (i) {
			if( mode==='first_is_open' && i===0 ){
			    $(this).addClass("active");
			    return;
			}
			$(this).removeClass("active");
			if ($(this).data('for')) {
			    $("#" + $(this).data('for')).addClass("hidden");
			} else {
			    $(this).next().addClass("hidden");
			}
		    });
		}
		collapse('first_is_open');
		container.find(".accordion").on("click", function () {
		    collapse();
		    $(this).addClass("active");
		    if ($(this).data('for')) {
			$("#" + $(this).data('for')).removeClass("hidden");
		    } else {
			$(this).next().removeClass("hidden");
		    }
		    observer.onselect(this);
		});
		return observer;
	    }
	};
	/////////////////////////////////////////////////////////
	// ORDER SECTION
	/////////////////////////////////////////////////////////
	var Order={
	    grid:null,
	    init:function(){
		Order.tableInit();
		//Order.summary.tableInit();
		Order.selector.init();
	    },
	    tools:{
		reload: function () {
		    Order.grid.reload();
		},
		entryDelete: function () {
		    var selected_rows = Order.grid.getSelectedRows();
		    if (!selected_rows.length) {
			App.flash("Ни одна строка не выбрана!");
			return;
		    }
		    if (!confirm("Удалить выделенные товары?")) {
			return;
		    }

		    var entry_ids = [];
		    for (var i in selected_rows) {
			entry_ids.push(Order.grid.getDataItem(selected_rows[i]).entry_id);
		    }
		    $.post('StockBuyManager/orderDelete', {entry_ids: entry_ids}, function (ok) {
			if (ok * 1) {
			    Order.grid.reload();
			}
		    });
		},
		entryCreate: function () {
		    $.post('StockBuyManager/orderCreate', function (insert_id) {
			Order.grid.reload();
		    });
		},
		out: function (out_type) {
		    var sorted = Order.grid.getSortColumns();
		    var params = {
			sortby: sorted.length ? sorted[0].columnId : '',
			sortdir: sorted.length ? (sorted[0].sortAsc ? 'ASC' : 'DESC') : '',
			filter: JSON.stringify(Order.grid.getFilter()),
			out_type: (out_type || '.xlsx')
		    };
		    var url = 'StockBuyManager/viewOrderGet/?' + $.param(params);
		    if (out_type === '.print') {
			window.open(url, 'print_tab');
		    } else {
			location.href = url;
		    }
		},
		print: function () {
		    this.out('.print');
		}
	    },
	    tableInit:function(){
		var settings = {
		    columns: [
			{id: "product_comment", field: "product_comment", name: "Коментарий", width: 120, sortable: true, editor: Slick.Editors.Text},
			{id: "product_code", field: "product_code", name: "Код", width: 100, sortable: true, editor: Slick.Editors.Text},
			{id: "product_name", field: "product_name", name: "Название", width: 300, sortable: true},
			{id: "product_quantity", field: "product_quantity", name: "Кол-во", width: 60, sortable: true, editor: Slick.Editors.Integer, cssClass: 'slick-align-right'},
			{id: "suggestion", field: "suggestion", name: "Варианты цен поставщиков", width: 900, sortable: true, formatter: Order.selector.make}
		    ],
		    options: {
			editable: true,
			autoedit: true,
			fitWidth:true,
			enableColumnReorder: false,
			enableFilter: true,
			multiSelect: true,
			url: 'StockBuyManager/orderFetch'
		    }
		};
		Order.grid = new SlickInfinite("#supply_order_sg", settings);
		Order.grid.onCellChange.subscribe(function (e, data) {
		    var updatedEntry = data.item;
		    var field = settings.columns[data.cell].field;
		    var value = updatedEntry[field];
		    Order.entryUpdate(updatedEntry.entry_id, field, value).done(function () {
			Order.grid.rowReload(data.row);
		    });
		});
		$(".x-stock-buy-manager-order-tools").click(function (e) {
		    var action = $(e.target).data('action');
		    if (action) {
			Order.tools[action] && Order.tools[action]();
		    }
		});
	    },
	    selector:{
		init:function(){
		    $("#supply_order_sg").on("click",function(e){
			var type=e.target.type;
			if( type==='radio' ){
			    Order.selector.swap( e.target.name.split("_")[1], e.target.value );
			}
		    });
		},
		make:function(row, cell, value, columnDef, dataContext) {
		    if( !value ){
			return '';
		    }
		    function controller_render(option,checked){
			var controller="";
			controller+='<div class="selector_token selector_tag" title="'+option[0]+'" style="border-left:solid 8px rgb('+255*red_ratio+','+200*green_ratio+',0)"><label>';
			controller+='<div class="selector_token" style="width:60px;">'+option[2]+'</div>';
			controller+='<div class="selector_token" style="height:16px;width:16px;"><input type="radio" value="'+option[1]+'" name="r_'+row+'" '+checked+'></div>';
			controller+='<div class="selector_token" >'+option[0]+'</div>';
			controller+='</label></div>';
			return controller;	
		    }
		    var selected_controller='';
		    var rest_controllers='';
		    var options=value.split("|");
		    for(var i in options){
			var red_ratio=i/options.length;
			var green_ratio=1-red_ratio;
			var option=options[i].split(":");
			if( option[0][0]=='#' ){
			    selected_controller+=controller_render(option,'checked');
			} else {
			    rest_controllers+=controller_render(option,'');
			}
		    }
		    return selected_controller+rest_controllers;
		},
		swap:function( row_index, supply_id ){
		    var row=Order.grid.getDataItem(row_index);
		    if( row.supply_id!==supply_id ){
			Order.entryUpdate(row.entry_id, 'supply_id', supply_id).done(function () {
			    Order.grid.reload();
			});
		    }
		}
	    },
	    entryUpdate:function(entry_id, field, value){
		return $.post('StockBuyManager/orderUpdate', {entry_id: entry_id, field: field, value: value}, function (ok) {
		    if (ok < 1) {
			Order.grid.reload();
			Summary.accordion.load();
		    }
		});
	    },
	    submit:function(supplier_company_id){
		$.post('StockBuyManager/orderSubmit',{supplier_company_id:supplier_company_id},function(doc_id){
		    if( doc_id*1 ){
			App.flash("Заказ сформирован");
			App.loadWindow('page/trade/document',{doc_id:doc_id});
			Order.grid.reload();
			Summary.accordion.load();
			Order.grid.setFilter({suggestion:''});
		    } else {
			App.flash("Заказ не сформирован");
		    }
		});
	    }
	};
	/////////////////////////////////////////////////////////
	// SUMMARY SECTION
	/////////////////////////////////////////////////////////
	var Summary={
	    selected:{},
	    list:{},
	    init:function(){
		Summary.accordion.load();
		$(".x-stock-buy-manager-summary-tools").click(function (e) {
		    var action = $(e.target).data('action');
		    if (action) {
			Summary.tools[action] && Summary.tools[action]();
		    }
		});
		$("#supply_order_summary_ac").click(function (e) {
		    var supplier_company_id = $(e.target).data('supplier-company-id');
		    if (supplier_company_id) {
			Order.submit(supplier_company_id);
		    }
		});
                $('.create_orders').click(function(){
                    Summary.tools.create_orders();
                });
	    },
	    accordion:{
		render:function(){
		    var acc = new Layout.Accordion("#supply_order_summary_ac");
		    Summary.selected=null;
		    acc.onselect = function (header_node) {
			var panel = header_node.nextElementSibling;
			var index=$(panel).data('index');
			var supplier_company_label='';
			Summary.selected=Summary.list[index];
			if( Summary.selected.supplier_company_id ){
			    supplier_company_label=Summary.selected.supplier_company_label;
			}
			Order.grid.setFilter({suggestion:(supplier_company_label?'#'+supplier_company_label:'')});
		    };
		},
		load:function(){
		    $.get('StockBuyManager/orderSummaryFetch', function (resp) {
			Summary.list = App.json(resp);
			App.renderTpl('supply_order_summary_ac', {summary: Summary.list});
			Summary.accordion.render();
		    });
		}
	    },
	    tools:{
		reload: function () {
		    Summary.accordion.load();
		},
                create_orders: function(){
                    $.post('StockBuyManager/ordersAbsentCreate', function (resp) {
			Summary.accordion.render();
		    });
                }
	    }
	};
        init();
    })(jQuery);
</script>
<style>
    #supply_order_summary_ac input{
        width: 80px;
        margin-left: 5px;
    }
    #supply_order_summary_ac label{
        display: block;
        clear: both;
        padding: 2px;
        text-align: right;
    }
    button.accordion {
        color: #444;
        cursor: pointer;
        padding: 5px;
        margin-bottom: 1px;
        width: 100%;
        border: none;
        border-radius: 0px;
        text-align: left;
        outline: none;
        font-size: 12px;
        transition: 0.8s;
    }

    button.accordion.active, button.accordion:hover {
        background-color: #Fe9; 
    }

    .accordion_panel {
        display: block;
        background-color: rgba(255,255,255,.3);
    }
    #supply_list_section {
        display: grid;
        grid-template-columns:200px auto;
        grid-gap:2px;
    }
    #supply_order_section{
        display: grid;
        grid-template-columns:450px auto;
        grid-gap:2px;	
    }
    .selector_token{
        display: inline-block;
        overflow: hidden;
        white-space: nowrap;
    }
    .selector_tag{
        width:150px;
	border-right:1px dotted black;
        margin:-2px;
        margin-right: 4px;
        padding:0px 2px 2px 2px; 
        height:20px;
        font-size: 12px;
    }
    .active .selector_tag{
        background: white;
    }
    
    .x-stock-buy-manager-order-holder{
        display: grid;
        grid-template-columns:200px auto;
        grid-gap:2px;	
    }
    
</style>
<div class="x-stock-buy-manager-order-holder">
    <div>
	<div style="float: left;font-weight: bold;padding-top: 8px;">
	    <img src="img/table16.png" style="width:16px;height: 16px;"> Заказ
	</div>
	<div style="float: right;" class="x-stock-buy-manager-summary-tools">
	    <span class="icon-24 icon-delete" title="Удалить стоку" data-action="entryDelete"> </span>
	    <span class="icon-24 icon-refresh" title="Обновить" data-action="reload"> </span> 
	</div>
	<div id="supply_order_summary_ac" style="overflow-y: auto;clear: both;" class="covert">
	    {{summary}}
		<button class="accordion">{{supplier_company_label}} ({{summary_count}})</button>
		<div class="accordion_panel" data-index="{{#}}">
		    {{if supplier_company_id}}
		    <div style="background: rgba(255,255,255,.6);padding: 3px;">Стоимость заказа</div>
		    <label>Сумма: <input name="summary_sum" value="{{summary_sum|blank>}}"></label>
		    <div style="background: rgba(255,255,255,.6);padding: 3px;">Характаристики заказа</div>
		    <label>Объем м3: <span style="font-size:14px">{{if volume_more|more>0}}>{{/if}}</span><input name="summary_volume" value="{{summary_volume|blank>}}"></label>
		    <label>Вес м3: <span style="font-size:14px">{{if weight_more|more>0}}>{{/if}}</span><input name="summary_weight" value="{{summary_weight|blank>}}"></label>
		    <div style="background: rgba(255,255,255,.6);padding: 3px;"> 
		    <button style="width:180px;margin: 5px;text-align: left" data-supplier-company-id="{{supplier_company_id}}"><img src="img/docnew.png" style="width:24px;height: 24px;"> Сформировать заказ</button>
		    </div>
		    {{/if}}
		</div>
	    {{/summary}}
	</div>
        <button class="create_orders"><img src="img/calc.png" style="width:24px;height: 24px;"> Сформировать заказы</button><br>
    </div>
    <div class="bmanager-order-entries">
	<div style="margin-right: 20px" class="x-stock-buy-manager-order-tools">
	    <div style="float: left;font-weight: bold;padding-top: 8px;">
		<img src="img/table16.png" style="width:16px;height: 16px;"> Заказ
	    </div>
	    <div style="float: right;font-weight: bold;padding-top: 8px;">
	    <span class="icon-24 icon-create" title="Добавить стоку" data-action="entryCreate"> </span>
	    <span class="icon-24 icon-delete" title="Удалить стоку" data-action="entryDelete"> </span>
	    <span class="icon-24 icon-download" title="Скачать таблицу" data-action="out"> </span> 
	    <span class="icon-24 icon-print" title="Напечатать" data-action="print"> </span> 
	    <span class="icon-24 icon-refresh" title="Обновить" data-action="reload"> </span>
	    </div>
	</div>
	<div id="supply_order_sg" style="clear: both;height: 500px;"></div>		
    </div>
</div>