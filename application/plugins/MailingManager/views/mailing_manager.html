<script>
App.mailing_manager=
(function(){
    Mark.pipes.date_simplify=function(date){
        let now=new Date();
        let then=new Date(date);
        let simplified=`${then.getHours().toString().padStart(2, '0')}:${then.getMinutes().toString().padStart(2, '0')}`;
        if( now.getTime()-then.getTime()>24*60*60*1000 || then.getDate()!==now.getDate() ){
            simplified=`${then.getDate().toString().padStart(2, '0')}.${(then.getMonth()+1).toString().padStart(2, '0')} ${simplified}`;
        }
        return simplified;
    };
    var holder_id="PluginMailing";
    var $holder=$("#"+holder_id);
    function init() {
        Layout.init();
        MessageList.init();
        MessageEditor.init();
    }

    var Layout={
        init:function(){
            Layout.adjustHolders();
            setTimeout(function(){
                Layout.adjustHolders();
            },1000);
        },
        adjustHolders:function(){
            Layout.calcDimensions("#PluginMailingManager_maillist",0,-30);
        },
        calcDimensions:function(query, dw, dh){
            var wheight = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
            var height = (wheight  + (dh || 0)) + 'px';// - $(query).position().top - 0
            var width = $(query).parent().width() + (dw || 0);
            $(query).css('height', height);
            $(query).css('width', width);
        },
        Accordion:function(query){
            var container = $(query);
            var observer = {
                onselect: function () {}
            };
            function collapse(mode) {
                container.find(".iss_accordion").each(function (i) {
                    if( mode==='first_is_open' && i===0 ){
                        $(this).addClass("active");
                        observer.onselect(this);
                        return;
                    }
                    $(this).removeClass("active");
                    if ($(this).data('for')) {
                        $("#" + $(this).data('for')).addClass("hidden");
                    } else {
                        $(this).next().addClass("hidden");
                    }
                });
            }
            container.find(".iss_accordion").on("click", function () {
                collapse();
                $(this).addClass("active");
                if ($(this).data('for')) {
                    $("#" + $(this).data('for')).removeClass("hidden");
                } else {
                    $(this).next().removeClass("hidden");
                }
                observer.onselect(this);
            });
            setTimeout(function(){
                collapse('first_is_open');
            },0);
            return observer;
        }
    };
    var MessageList={
        current_filter:'',
        search_clock:0,
        init:function(){
            MessageList.batch.load();
            MessageList.list.init();
            $("#PluginMailingManager_list_filter").on('input',function(){
                MessageList.current_filter=$(this).val();
                clearTimeout(MessageList.search_clock);
                MessageList.search_clock=setTimeout(function(){
                    MessageList.batch.load();
                },800);
            });
        },
        initControls: function(){
            Layout.Accordion('#PluginMailingManager_maillist .clickable-list').onselect=function( node ){
                if($(node).data('index') !== '--'){
                    MessageList.batch.selected_index=$(node).data('index');
                } else {
                    return;
                }
                MessageList.list.load(MessageList.batch.batch_list[MessageList.batch.selected_index]);
            };
            $("#PluginMailingManager_maillist .new-list").on('click',function(){
                MessageEditor.action = 'new';
                MessageEditor.message = $.extend(true,{},MessageEditor.empty_message);
                MessageList.list.select(MessageEditor.action);
            });
            $("#PluginMailingManager_maillist *[data-action='delete']").on('click',function(){
                var message_batch_label = $(this).attr('data-id').split('_')[0];
                MessageList.batch.delete(message_batch_label);
                MessageEditor.renew();
                return;
            });
            $("#PluginMailingManager_maillist *[data-action='send']").on('click',function(){
                var message_batch_label = $(this).attr('data-id').split('_')[0];
                MessageList.batch.send(message_batch_label);
                return;
            });
            $("#PluginMailingManager_maillist *[data-action='cancel']").on('click',function(){
                var message_batch_label = $(this).attr('data-id').split('_')[0];
                MessageList.batch.cancel(message_batch_label);
                return;
            });
        },
        batch:{
            batch_list:[],
            selected_index:'--',
            load:function(){
                $.get("MailingManager/messageBatchListGet",{filter:MessageList.current_filter},function(resp){
                    MessageList.batch.batch_list=App.json(resp);
                    MessageList.batch.render();
                });
            },
            delete:function(message_batch_label){
                MessageList.list.selected_id = 0;
                $.get("MailingManager/messageBatchDelete",{message_batch_label: message_batch_label},function(resp){
                    MessageList.batch.selected_index='--';
                    MessageList.batch.load();
                });
            },
            send:function(message_batch_label){
                MessageList.list.selected_id = 0;
                $.get("MailingManager/messageBatchSend",{message_batch_label: message_batch_label},function(resp){
                    MessageList.batch.load();
                });
            },
            cancel:function(message_batch_label){
                MessageList.list.selected_id = 0;
                $.get("MailingManager/messageBatchCancelSending",{message_batch_label: message_batch_label},function(resp){
                    MessageList.batch.load();
                });
            },
            render:function(){
                App.renderTpl('PluginMailingManager_maillist',MessageList.batch.batch_list);
                MessageList.initControls();
                setTimeout(function(){
                    $("#PluginMailingManager_maillist .iss_accordion[data-index='"+MessageList.batch.selected_index+"']").click();
                },10);
            },
            create: function(){
                var batch = {
                    handler:$('select[name=message_handler]').val(),
                    manual_reciever_list: MessageEditor.data.manual_reciever_list ,
                    reciever_list_id:$('select[name=reciever_list_id]').val(),
                    body:window.frames['editor_iframe'].getContent(),
                    subject:$('input[name=message_subject]').val()
                };
                MessageList.batch.validate(batch);
                if( MessageEditor.mail_error !== ''){
                    alert('Ошибка: ' + MessageEditor.mail_error);
                    return;
                }
                App.flash("Рассылка формируется!");
                $.post("MailingManager/messageBatchCreate", {message_batch: JSON.stringify(batch)}, function (resp) {
                    var response=App.json(resp);
                    if ( response && response.messages_created ) {
                        App.flash("Создано сообщений "+response.messages_created);
                    } else {
                        App.flash("Ни одного сообщения не создано!");
                    }
                    if( response && response.error_log ){
                        var log=response.error_log.join("\n");
                        log && alert(log);
                    }
                    MessageList.batch.load();
                });
            },
            validate: function(batch){
                MessageEditor.mail_error = '';
                if(( !batch.reciever_list_id || batch.reciever_list_id == '-1' ) && batch.manual_reciever_list.length == 0){
                    MessageEditor.mail_error += '\nАдресаты не указаны!';
                }
                if(batch.subject === ''){
                    MessageEditor.mail_error += '\nУкажите тему!';
                }
                if(batch.body === ''){
                    MessageEditor.mail_error += '\nПустое сообщение!';
                }
                return;
            }
        },
        list:{
            selected_id:0,
            init:function(){
                MessageList.list.tpl=$("#PluginMailingManager_list_tpl").html();
                MessageList.list.initControls();
            },
            initControls: function(){
                $(`#PluginMailingManager_maillist`).on('click',function(e){
                    var node=$(e.target).parent();
                    var action=$(e.target).data('action')||$(e.target).parent().data('action');
                    if( MessageList.list[action] && node.data('id') ){
                        var message_id = node.data('id').split('_')[1];
                        MessageList.list[action](message_id);
                    }
                });
            },
            load:function( group_entry ){
                var filter={
                    filter:MessageList.current_filter,
                    message_batch_label:group_entry.message_batch_label
                };
                $.post("MailingManager/messageListGet",filter,function(resp){
                    var maillist=App.json(resp);
                    MessageList.list.render(maillist);
                });
            },
            delete:function(message_id){
                MessageList.list.selected_id = 0;
                $.get("MailingManager/messageDelete",{message_id: message_id},function(resp){
                    MessageList.batch.load();
                });
                MessageEditor.renew();
            },
            send:function(message_id){
                MessageList.list.selected_id = 0;
                $.get("MailingManager/messageSend",{message_id: message_id},function(resp){
                    MessageList.batch.load();
                });
            },
            cancel:function(message_id){
                MessageList.list.selected_id = 0;
                $.get("MailingManager/messageCancelSending",{message_id: message_id},function(resp){
                    MessageList.batch.load();
                });
            },
            render:function(maillist){
                var html = Mark.up(MessageList.list.tpl,maillist);
                $("#PluginMailingManager_maillist div[data-index='" + MessageList.batch.selected_index + "']").html(html).click(function(e){
                    //var id = $(e.target.parentNode).data('id');
                    //MessageList.list.select(id);
                });
            },
            select:function(id){
                if( !id || id == MessageList.list.selected_id ){
                    return;
                }
                MessageList.list.selected_id = id;
                $(`#PluginMailingManager_maillist .PluginMailingManager_list_row_selected`).removeClass('PluginMailingManager_list_row_selected');
                var $selected_row=$(`#PluginMailingManager_maillist div[data-id=_${MessageList.list.selected_id}]`);
                $selected_row.addClass("PluginMailingManager_list_row_selected");
                MessageEditor.load(MessageList.list.selected_id);
            }
        }
    };
    var MessageEditor={
        empty_message: {
            message_handler: 'email',
            message_subject: '',
            reciever_field: '',
            message_body: '<p></p>'
        },
        data: {},
        action: 'view',
        current_template_index:'-1',
        current_reciever_index:'-1',
        current_message_body: '<p></p>',
        mail_error: '',
        subject_focus: false,
        init:function(){
            MessageEditor.initControls();
            MessageEditor.getSettings();
            window.frames['editor_iframe'].html= '<div></div>';
        },
        initControls: function(){
            $('.recievers-list-edit').click(function(){
                App.loadWindow("MailingManager/reciever_list", MessageEditor.data).progress(function(status,reciever_list){
                    if( status === 'reciever_list_updated' ){
                        MessageEditor.data.reciever_list=reciever_list;
                        MessageEditor.updateSettings();
                    }
                    if( status === 'close' ){
                        MessageEditor.renderNew();
                    }
                });
            });
            App.setupForm('#PluginMailingManager_mailnew', MessageEditor.message, 'use_inp_values').change(function (node) {
                MessageEditor.message[this.name] = App.val(this);
            });
            $('input[name="message_subject"]').focus(function(){
                MessageEditor.subject_focus = true;
            });
            $('input[name="message_subject"]').blur(function(){
                setTimeout(function(){ 
                    MessageEditor.subject_focus = false; 
                }, 1000 );
            });
            $('input[name="message_subject"]').on('change',function(){
                $('input[name="message_subject"]').focus();
                MessageEditor.subject_focus = true; 
            });
            $('.template_mark_down').click(function(){
                var field_name = $(this).attr('data-field_name');
                var field_label=$(this).html();
                var token=`{{${field_name}(${field_label})}}`;
                
                if(MessageEditor.subject_focus){
                    var input_value = $('input[name="message_subject"]').val();
                    $('input[name="message_subject"]').val(input_value + token);
                    $('input[name="message_subject"]').change();
                } else {
                    window.frames['editor_iframe'].tinymce.activeEditor.insertContent(token);
                }
            });
            $('select[name="template_list"]').change(function(){
                MessageEditor.current_template_index = $(this).val();
                var current_template = MessageEditor.data.template_list[MessageEditor.current_template_index];
                if(current_template){
                    window.frames['editor_iframe'].setContent(current_template.html);
                    $('input[name="message_subject"]').val(current_template.subject);
                } else {
                    window.frames['editor_iframe'].setContent('<p></p>');
                    $('input[name="message_subject"]').val('');
                }
                $('#mailing_manager_tpl_edit,#mailing_manager_tpl_delete').attr('disabled',!current_template);
            });
            $('select[name="reciever_list"]').change(function(){
                MessageEditor.current_reciever_index = $(this).val();
            });
            $('#mailing_manager_tpl_add').click(function(){
                MessageEditor.templateSave();
            });
            $('#mailing_manager_tpl_edit').click(function(){
                MessageEditor.templateEdit();
            });
            $('#mailing_manager_tpl_delete').click(function(){
                MessageEditor.templateDelete();
            });
            $('#mailing_manager_batch_create').click(function(e){
                MessageList.batch.create();
            });
            $('input[name="reciever_field"]').on('change',function(){
                MessageEditor.checkRecieverCorrectness(this.value);
            });
        },
        load:function(message_id){
            if( message_id==='new' ){
                MessageEditor.renderNew();
            } else {
                $.post('MailingManager/messageGet', {message_id: message_id}, function (resp) {
                    if (resp) {
                        MessageEditor.message = JSON.parse(resp);
                        MessageEditor.renderView();
                    }
                });
            }
        },
        renderNew: function(){
            $('#PluginMailingManager_mailnew, #PluginMailingManager_mailview').hide();
            $('#PluginMailingManager_mail' + MessageEditor.action).show();
            function object2array( obj ){
                var _array=[];
                for(let _id in obj){
                    let item=obj[_id];
                    item.id=_id;
                    _array.push(item);
                }
                return _array;
            }
            var params = {
                message: MessageEditor.message, 
                template_list: object2array(MessageEditor.data.template_list),
                reciever_list: object2array(MessageEditor.data.reciever_list),
                manual_reciever_list: MessageEditor.data.manual_reciever_list||[]
            };
            App.renderTpl('select[name=template_list]', params);
            App.renderTpl('select[name=reciever_list_id]', params);
            App.renderTpl('.reciever-list-tags', params);
            $("select[name=reciever_list_id]").val(MessageEditor.current_reciever_index);
            $("#PluginMailingManager_mailnew .delete-manual_reciever").on('click',function(){
                var reciever_index = $(this).attr('data-reciever_index');
                var result = [];
                for(var i in MessageEditor.data.manual_reciever_list){
                    if(i !== reciever_index){
                        result.push(MessageEditor.data.manual_reciever_list[i]);
                    }
                }
                MessageEditor.data.manual_reciever_list = result;
                MessageEditor.renew();
            });
        },
        renderView:function(){
            App.renderTpl("#PluginMailingManager_mailview",MessageEditor.message);
            $("#PluginMailingManager_mailnew").hide();
            $("#PluginMailingManager_mailview").show();
        },
        renew: function (){
            MessageEditor.action = 'new';
            MessageEditor.renderNew();
            window.frames['editor_iframe'].onload=function(){
                MessageEditor.current_message_body = window.frames['editor_iframe'].getContent();
                MessageEditor.renderMessageBody();
            };
        },
        renderMessageBody: function(){
            var subject='';
            if(MessageEditor.current_template_index != '-1'){
                MessageEditor.current_message_body=MessageEditor.data.template_list[MessageEditor.current_template_index].html;
                subject=MessageEditor.data.template_list[MessageEditor.current_template_index].subject;
            }
            $('input[name="message_subject"]').val(subject);
            window.frames['editor_iframe'].html=MessageEditor.current_message_body;
                    
                
            /*onload=function(){
                setTimeout(function(){
                    window.frames['editor_iframe'].setContent(MessageEditor.current_message_body);
                },100);
            };*/
            $('#mailing_manager_tpl_edit,#mailing_manager_tpl_delete').attr('disabled',MessageEditor.current_template_index == '-1');
            $("select[name=template_list]").val(MessageEditor.current_template_index);
        },
        getSettings:function(){
            $.post('MailingManager/dataGet', function (resp) {
                if (resp) {
                    MessageEditor.data.reciever_list = {};
                    MessageEditor.data.template_list = {};
                    MessageEditor.data.manual_reciever_list = [];
                    var response = JSON.parse(resp);
                    if(response && response.settings){
                        MessageEditor.data.reciever_list = response.settings.reciever_list;
                        MessageEditor.data.template_list = response.settings.template_list;
                    }
                    //MessageEditor.renderNew();
                }
            });
        },
        updateSettings: function () {
            $.post("MailingManager/dataUpdate", {settings: JSON.stringify(MessageEditor.data)},function(ok){
                if( ok*1 ){
                    App.flash("Настройки сохранены!");
                }
            });
        },
        templateSave: function(){
            var content = window.frames['editor_iframe'].getContent();
            if(content === ""){
                alert('Ошибка: Пустое сообщение');
                return;
            }
            var template_name = '';
            if(MessageEditor.data.template_list[MessageEditor.current_template_index]){
                template_name = MessageEditor.data.template_list[MessageEditor.current_template_index].name;
            } else {
                template_name=prompt('Название шаблона', 'Новый шаблон');
            }
            var template_object = {
                name: template_name,
                subject:$('input[name="message_subject"]').val(),
                html: content
            };
            if(!template_object.name){
                alert('Ошибка: Пустое название шаблона!');
                return;
            }
            
            if(MessageEditor.current_template_index == '-1'){
                MessageEditor.current_template_index= Date.now();
                MessageEditor.data.template_list[MessageEditor.current_template_index]=template_object;
            } else {
                MessageEditor.data.template_list[MessageEditor.current_template_index] = template_object;
            }
            MessageEditor.action = 'new';
            MessageEditor.updateSettings();
            MessageEditor.renderNew();
        },
        templateDelete: function(){
            if(confirm("Удалить данный шаблон?")){
                delete MessageEditor.data.template_list[MessageEditor.current_template_index];
                MessageEditor.current_template_index='-1';
                MessageEditor.action = 'new';
                MessageEditor.updateSettings();
                MessageEditor.renderNew();
            }
        },
        templateEdit:function(){
            var new_name=prompt('Изменить название шаблона', MessageEditor.data.template_list[MessageEditor.current_template_index].name);
            if( new_name===null ){
                return;
            }
            MessageEditor.data.template_list[MessageEditor.current_template_index].name=new_name;
            MessageEditor.action = 'new';
            MessageEditor.updateSettings();
            MessageEditor.renderNew();
        },
        checkRecieverCorrectness: function(input){
            var separators = [' ',';',',','\r\n', '\r','\n','\t'];
            var reciever_list = input.split(/[ ,\/;\r\n\t]/);
            reciever_list = reciever_list.filter(function(value, index, self){
                return self.indexOf(value) === index;
            });
            for (var i in reciever_list) {
                var reciever_contact = reciever_list[i];
                var contact = MessageEditor.validateContact(reciever_contact);
                if(!contact){
                    //alert("You have entered an invalid email address: "+reciever_contact);
                    continue;
                } 
                MessageEditor.data.manual_reciever_list.push(contact);
            }
            MessageEditor.renew();
            $('input[name="reciever_field"]').val("");
        },
        validateContact: function (contact) {
            if(contact === '' || contact === " "){
                return false;
            }
            if (/^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/.test(contact)){
               return contact;
            }
            if (/^\+?[78][-\(]?\d{3}\)?-?\d{3}-?\d{2}-?\d{2}$/.test(contact)){
                if(contact.substring(0, 1) == 7){
                    contact = '+'+contact;
                }
                return contact;
            }
            return false;
        }

    };
    init();
    
    return {
        reload_recievers: function(reciever_list){
            MessageEditor.data.reciever_list = reciever_list;
            MessageEditor.renew();
        },
        reload_list:MessageList.batch.load
    };
})();


</script>
<script type="text/tpl" id="PluginMailingManager_list_tpl">
    <div class="PluginMailingManager_list">
        {{.}}
            <div data-id="_{{message_id}}" data-action="select" style="display: contents;" class="PluginMailingManager_list_row">
                <div>
                    {{if message_status|equals>done}}
                        <img src="img/ok.png" title="Доставлено" style="margin:2px;">
                    {{/if}}
                    {{if message_status|equals>processing}}
                        <img src="img/time.png" title="Ожидает доставки" style="margin:2px;">
                    {{/if}}
                    {{if message_status|equals>created}}
                        <img src="img/red.png" title="Не доставлено" style="margin:2px;">
                    {{/if}}
                </div>
                <div>{{message_recievers}}</div>
                <div>{{message_subject}}</div>
                
                {{if message_status|equals>processing}}
                <div data-action="cancel" data-id="{{message_batch_label}}_{{message_id}}">⏸</div>
                {{else}}
                <div data-action="send" data-id="{{message_batch_label}}_{{message_id}}">▶</div>
                {{/if}}
                <div data-action="delete" data-id="{{message_batch_label}}_{{message_id}}">❌</div>
            </div>
        {{/.}}
    </div>
</script>
<div id="PluginMailingManager"  style="display: grid;grid-template-columns:500px auto">
    <div>
        <input type="search" id="PluginMailingManager_list_filter" style="width:calc( 100% - 32px );height: 35px;background-color: #fffd" placeholder="Фильтр">
        <img src="img/reload.png" style="height: 32px;width: auto;float:right;cursor: pointer" onclick="App.mailing_manager.reload_list()"/>
        <div id="PluginMailingManager_maillist" class="iss_accordion" style="max-height: 100vh; overflow-y: auto;">
            <div class="clickable-list">
            <button class="iss_accordion new-list" data-index="--">Новая рассылка</button> 
            <div class="iss_accordion_panel" data-index="--"></div>
                {{.}}
                    <button class="iss_accordion" data-index="{{#}}">
                        {{message_reason}} / {{created_at|date_simplify}} / {{message_handler}} ({{message_count}})
                        <b data-mailgroup_id="{{#}}" data-action="delete" data-id="{{message_batch_label}}_*" style="cursor: pointer;">❌</b>
                        {{if message_batch_statuses|like>processing.*}}
                        <b data-mailgroup_id="{{#}}" data-action="cancel" data-id="{{message_batch_label}}_*" style="cursor: pointer;">⏸</b>
                        {{else}}
                        <b data-mailgroup_id="{{#}}" data-action="send" data-id="{{message_batch_label}}_*" style="cursor: pointer;">▶</b>
                        {{/if}}
                    </button>
                    <div class="iss_accordion_panel" data-index="{{#}}"></div>
                {{/.}}
            </div>
        </div>
    </div>
    <div id="PluginMailingManager_mailview" class="right-block" style="display: none">
        <div class="mail-panel-header">
            <div class="inp_group info-row">
                    <b>Тип сообщения:</b>
                    <div class="info-column">{{ message_handler }}</div>
            </div>
            <div class="inp_group info-row">
                    <b>Кому:</b>
                    <div class="info-column">{{ message_recievers }}</div>
            </div>
            <div class="inp_group info-row">
                    <b>Тема:</b>
                    <div class="info-column">{{ message_subject }}</div>
            </div>
        </div>
        <div class="mail-panel-body">    
            <div class="inp_group message-body-row">
                    <div class="message-body-column">{{ message_body }}</div>
            </div>
        </div>
    </div>
    <div id="PluginMailingManager_mailnew" class="right-block" style="display: none">
        <div class="mail-panel-header">
            <div class="type-row row">
                <label>Тип рассылки:</label>
                <select  name="message_handler">
                      <!--<option value="auto">Авто</option>-->
                      <option value="email">Email</option>
                      <option value="sms">Sms</option>
                </select>
            </div>
            <div class="reciever-row row">
                <label>Кому:</label>
                <div class="reciever-row-container">
                    <div class="recievers-manual-container">
                        <div class="reciever-list-tags">
                            <!--{{manual_reciever_list}}-->
                            <span class="reciever-tag" data-reciever_index="{{ # }}">
                                {{ . }}
                                    <b class="delete-manual_reciever" data-reciever_index="{{ # }}" style="cursor: pointer;">×</b>
                            </span>
                             <!--{{/manual_reciever_list}}-->
                        </div>
                        <input type="text" placeholder="Введите епочту или телефоны получателей..." name="reciever_field" value="">
                    </div>
                    <div>
                        <select class="recievers-list"  name="reciever_list_id">
                           <option value="-1">- Выберите список клиентов -</option>
                            <!--{{reciever_list}}-->
                           <option value="{{ id }}">{{ reciever_list_name }}</option>
                             <!--{{/reciever_list}}-->
                        </select>
                    </div>
                    <div>
                        <button class="recievers-list-edit"><img src="img/edit-24.png"> Получатели</button>
                    </div>
                </div>
            </div>
            <div class="subject-row row">
                <label>Тема:</label>
                <input type="text" placeholder="Введите тему сообщения..." name="message_subject" value="">
            </div>
        </div>
        <div class="mail-panel-body">  
            <div class="iframe-block">
                <iframe id="editor_iframe" name="editor_iframe" style="height:505px;width: 100%;border: none;" src="page/dialog/text_editor_iframe.html"></iframe>
                <div class="iframe-buttons">
                    <button class="template_mark_down" data-field_name="date_today">Дата сегодня</button>
                    
                    <button class="template_mark_down" data-field_name="company_name">Контрагент Название</button>
                    <button class="template_mark_down" data-field_name="company_person">Контрагент контактное лицо</button>
                    <button class="template_mark_down" data-field_name="company_director">Контрагент директор</button>
                    
                    <button class="template_mark_down" data-field_name="manager_sign">Менеджер ФИО</button>
                    <button class="template_mark_down" data-field_name="manager_phone">Менеджер телефон</button>
                    <button class="template_mark_down" data-field_name="manager_position">Менеджер должность</button>
                    
                    <button class="template_mark_down" data-field_name="DebtManager.PaymentCalendar">Календарь платежей</button>
                    <button class="template_mark_down" data-field_name="DebtManager.DebtTotal">Задолженность общая</button>
                    <button class="template_mark_down" data-field_name="DebtManager.DebtExpired">Задолженность просроченная</button>
                </div>
            </div>
            <div class="templates-row">
                <button type="button" id="mailing_manager_batch_create"><img src="img/add.png"> Создать рассылку</button> |
                <button type="button" id="mailing_manager_tpl_add"><img src="img/save-24.png"> Сохранить шаблон</button>
                <select name="template_list" >
                    <option value="-1">- Шаблон не выбран -</option>
                    <!--{{template_list}}-->
                    <option value="{{id}}">{{name}}</option>
                    <!--{{/template_list}}-->
                </select>
                <button type="button" id="mailing_manager_tpl_delete" disabled><img src="img/delete.png"></button>
                <button type="button" id="mailing_manager_tpl_edit" disabled><img src="img/edit-24.png"></button>
            </div>
        </div>
    </div>
</div>
<style>
    button.iss_accordion {
        color: #444;
        cursor: pointer;
        padding: 5px;
        margin-bottom: 1px;
        width: 100%;
        border: none;
        border-radius: 0px;
        text-align: left;
        outline: none;
        font-size: 12px;
        transition: 0.8s;
        background: #Fff;
        height: 35px;
    }
    button.iss_accordion.active, button.iss_accordion:hover {
        background-color: #Fe9;
    }
    .iss_accordion_panel {
        display: block;
        background-color: rgba(255,255,255,.3);
        max-height: 300px;
        overflow: auto;
    }
    .PluginMailingManager_list{
        display: grid;
        grid-template-columns: 25px minmax(auto, 270px) minmax(auto, 250px) 25px 25px;
        grid-row-gap:1px;
        margin-left:10px;
        padding-top: 2px;
        padding-bottom: 2px;
    }
    .PluginMailingManager_list div{
        background-color: #fff6;
        padding: 2px;
        padding-top: 3px;
        text-overflow:elipsis;
    }
    .PluginMailingManager_list [data-action]{
        padding: 5px;
        text-align: center;
    }
    .PluginMailingManager_list [data-action]:hover{
        background-color: #fe9;
        padding: 4px;
        border: 1px solid white;
    }
    
    
    .PluginMailingManager_list_row:hover div{
        background-color: #fffd;
        cursor: pointer;
    }
    .PluginMailingManager_list_row_selected div{
        background-color: #fffd;
    }

    .iss_accordion  button b{
        float: right;
        padding: 5px 0.5em;
        font-size: 13px;
        border-radius: 5px;
        margin: -8px 0.1em;
    }
    
    .iss_accordion  button b:hover{
        color: #1b71bd;
        background-color: aliceblue;
    }
    /*======================================*/
    .right-block{
        background-color: #ffffffc2;
        border-left: 2px solid lightgray;
    }
    .right-block .mail-panel-header{
        background-color: #ffffff8c;
        padding: 0.5em;
    }
    
    .right-block .mail-panel-body{
        border-top: 1px solid lightgray;
    }


    
    #PluginMailingManager_mailnew .inp_group{
        
    }
    #PluginMailingManager_mailnew select{
        border: 1px solid lightgray;
    }
    #PluginMailingManager_mailnew  select[name="message_handler"]{
        display: block;   
        margin-top: 5px;
    }
    #PluginMailingManager_mailnew .reciever-row-container{
        display: grid;
        grid-template-columns: auto min-content 110px;
    }
    
    #PluginMailingManager_mailnew .row{
        padding: 0.3em;
        border-bottom: 1px solid lightgray;
    }
    #PluginMailingManager_mailnew select{
        height: 32px;
    }    
    #PluginMailingManager_mailnew .row input{
        width: 100%;
        border: none;
        background-color: transparent;
        height: 30px;
    }
    
    #PluginMailingManager_mailnew  .inp_group label{
        display: grid;
        grid-template-columns: 10% 75% auto;
    }
    #PluginMailingManager_mailnew .right-block .inp_group b{
        width: auto;
    }

    #PluginMailingManager_mailnew  textarea{
        width: 100%;
        height: 300px;
    }
    #PluginMailingManager_mailnew .iframe-block{
        display: grid;
        grid-template-columns: 85% 15%;
    }
    #PluginMailingManager_mailnew .iframe-buttons{
        background-color: #ffffff;
        border-bottom: 1px solid lightgray;
    }
    #PluginMailingManager_mailnew .iframe-buttons button{
        display: block;
        width: 100%;
        background-color: white;
        border:none;
        border-bottom: 1px solid #ccc;
        padding: 0.7em;
        border-radius: 0;
        cursor: pointer;
        transition: 0.2s ease;
    }
    #PluginMailingManager_mailnew .iframe-buttons button:hover{
        background: #Fe9;
    }
    #PluginMailingManager_mailnew .templates-row{
        padding: 0.5em;
        background-color: white;
        border-bottom: 1px solid lightgray;
    }
    
    #PluginMailingManager_mailnew .submit-row{
        padding: 0.5em;
        text-align: center;
    }
    #PluginMailingManager_mailview .inp_group{
        padding: 0.5em;
        margin: 0;
    }
    #PluginMailingManager_mailview .inp_group.info-row{
        display: block ruby;
    }
    #PluginMailingManager_mailnew .inp_group b,
    #PluginMailingManager_mailview .inp_group b{
        font-weight: bold;
    }
    #PluginMailingManager_mailview .info-column{
        margin-left: 0.5em;
        font-style: italic;
    }
    #PluginMailingManager_mailview .message-body,
    #PluginMailingManager_mailview .message-table{
        width: 100% !important; 
    }
    #PluginMailingManager_mailview .message-body-column{
        padding: 1.5em;
    }
    #PluginMailingManager_mailnew .reciever-tag{
        color: #0e2d7c;
        background: linear-gradient(to bottom,#EFF5FF 0,#E0ECFF 100%);
        padding: 5px 0px 5px 10px;
        border: 1px solid #95B8E7;
        margin: 5px 5px 0;
        border-radius: 5px;
        box-sizing: border-box;
        display: inline-block;
        line-height: 1em;
        overflow: hidden;
    }
    #PluginMailingManager_mailnew .reciever-tag b{
        color: #202020;
        margin-left: 5px;
        padding: 5px;
        background: linear-gradient(to bottom,#C9D7F0 0,#BFCBDF 100%);
        box-sizing: border-box;
    }
    #PluginMailingManager_mailnew .reciever-tag b:hover{
        background: #4884d5;
        color: white;
    }
    .PluginMailingManager_list_row img{
        max-width: 16px;
    }
    
</style>
